{"title":"$:/plugins/oeyoews/vue-plum","description":"vue-plum","author":"oeyoews","version":"0.0.1","core-version":">=5.3.0","type":"application/json","plugin-type":"plugin","name":"vue-plum","meat#disabled":"yes","qrcode":"yes","created":"2024-03-15","dependents":"$:/plugins/oeyoews/neotw-vue3","list":"readme","text":"{\"tiddlers\":{\"$:/plugins/oeyoews/vue-plum/templates/app.vue\":{\"text\":\"<template>\\n  <div class=\\\"fixed top-0 bottom-0 left-0 right-0 pointer-events-none print:hidden\\\" style=\\\"z-index: -1\\\"\\n    :style=\\\"`mask-image: ${mask};--webkit-mask-image: ${mask};`\\\">\\n    <canvas ref=\\\"el\\\" width=\\\"400\\\" height=\\\"400\\\" />\\n  </div>\\n</template>\",\"title\":\"$:/plugins/oeyoews/vue-plum/templates/app.vue\",\"hide-body\":\"yes\"},\"$:/plugins/oeyoews/vue-plum/readme\":{\"title\":\"$:/plugins/oeyoews/vue-plum/readme\",\"description\":\"vue-plum\",\"text\":\"<!-- plugin template readme -->\\n\\n<!-- !! Motivation -->\\n\\n<!-- your plugin motivation, or why you write this plugin -->\\n\\n> 梅花树\"},\"$:/plugins/oeyoews/vue-plum/app.js\":{\"title\":\"$:/plugins/oeyoews/vue-plum/app.js\",\"text\":\"/*\\\\\\ntitle: $:/plugins/oeyoews/vue-plum/app.js\\ntype: application/javascript\\nmodule-type: library\\n\\n@see: https://github.com/antfu/antfu.me/blob/eb52c0f20a2673ea5af15a4c9154e4181fe177d5/src/components/Plum.vue#L19\\n\\n\\\\*/\\n\\nconst { ref, reactive, computed, onMounted } = window.Vue;\\n\\nconst r180 = Math.PI;\\nconst r90 = Math.PI / 2;\\nconst r15 = Math.PI / 12;\\nconst color = '#88888825';\\n\\nconst getTemplate = require('$:/plugins/oeyoews/neotw-vue3/getTemplate.js');\\n\\nconst MIN_BRANCH = 30;\\nconst { random } = Math;\\n\\nfunction initCanvas(canvas, width = 400, height = 400, _dpi) {\\n  const ctx = canvas.getContext('2d');\\n\\n  const dpr = window.devicePixelRatio || 1;\\n  const bsr =\\n    ctx.webkitBackingStorePixelRatio ||\\n    ctx.mozBackingStorePixelRatio ||\\n    ctx.msBackingStorePixelRatio ||\\n    ctx.oBackingStorePixelRatio ||\\n    ctx.backingStorePixelRatio ||\\n    1;\\n\\n  const dpi = _dpi || dpr / bsr;\\n\\n  canvas.style.width = `${width}px`;\\n  canvas.style.height = `${height}px`;\\n  canvas.width = dpi * width;\\n  canvas.height = dpi * height;\\n  ctx.scale(dpi, dpi);\\n\\n  return { ctx, dpi };\\n}\\n\\nfunction polar2cart(x = 0, y = 0, r = 0, theta = 0) {\\n  const dx = r * Math.cos(theta);\\n  const dy = r * Math.sin(theta);\\n  return [x + dx, y + dy];\\n}\\n\\nfunction useRafFn(fn) {\\n  let rafId = null;\\n\\n  const resume = () => {\\n    if (!rafId) {\\n      const loop = () => {\\n        fn();\\n        rafId = requestAnimationFrame(loop);\\n      };\\n      loop();\\n    }\\n  };\\n\\n  const pause = () => {\\n    cancelAnimationFrame(rafId);\\n    rafId = null;\\n  };\\n\\n  return { resume, pause };\\n}\\n\\nconst app = () => {\\n  const component = {\\n    setup() {\\n      const el = ref(null);\\n\\n      const useWindowSize = () => {\\n        const width = ref(window.innerWidth);\\n        const height = ref(window.innerHeight);\\n\\n        const updateWindowSize = () => {\\n          width.value = window.innerWidth;\\n          height.value = window.innerHeight;\\n          console.log(width.value, size.width);\\n        };\\n\\n        onMounted(() => {\\n          // 原版也无法实现响应式更新\\n          // window.addEventListener('resize', updateWindowSize);\\n        });\\n\\n        return {\\n          width,\\n          height,\\n        };\\n      };\\n\\n      const size = reactive(useWindowSize());\\n\\n      const start = ref(() => {});\\n      const len = ref(6);\\n      const stopped = ref(false);\\n\\n      onMounted(async () => {\\n        const canvas = el.value;\\n        const { ctx } = initCanvas(canvas, size.width, size.height);\\n        const { width, height } = canvas;\\n\\n        let steps = [];\\n        let prevSteps = [];\\n\\n        const step = (x, y, rad, counter = { value: 0 }) => {\\n          const length = random() * len.value;\\n          counter.value += 1;\\n\\n          const [nx, ny] = polar2cart(x, y, length, rad);\\n\\n          ctx.beginPath();\\n          ctx.moveTo(x, y);\\n          ctx.lineTo(nx, ny);\\n          ctx.stroke();\\n\\n          const rad1 = rad + random() * r15;\\n          const rad2 = rad - random() * r15;\\n\\n          if (\\n            nx < -100 ||\\n            nx > size.width + 100 ||\\n            ny < -100 ||\\n            ny > size.height + 100\\n          )\\n            return;\\n\\n          const rate = counter.value <= MIN_BRANCH ? 0.8 : 0.5;\\n\\n          if (random() < rate) steps.push(() => step(nx, ny, rad1, counter));\\n\\n          if (random() < rate) steps.push(() => step(nx, ny, rad2, counter));\\n        };\\n\\n        let lastTime = performance.now();\\n        const interval = 1000 / 40;\\n\\n        let controls;\\n\\n        const frame = () => {\\n          if (performance.now() - lastTime < interval) return;\\n\\n          prevSteps = steps;\\n          steps = [];\\n          lastTime = performance.now();\\n\\n          if (!prevSteps.length) {\\n            controls.pause();\\n            stopped.value = true;\\n          }\\n\\n          prevSteps.forEach((i) => {\\n            if (random() < 0.5) steps.push(i);\\n            else i();\\n          });\\n        };\\n\\n        controls = useRafFn(frame, { immediate: false });\\n\\n        const randomMiddle = () => random() * 0.6 + 0.2;\\n\\n        start.value = () => {\\n          controls.pause();\\n          ctx.clearRect(0, 0, width, height);\\n          ctx.lineWidth = 1;\\n          ctx.strokeStyle = color;\\n          prevSteps = [];\\n          steps = [\\n            () => step(randomMiddle() * size.width, -5, r90),\\n            () => step(randomMiddle() * size.width, size.height + 5, -r90),\\n            () => step(-5, randomMiddle() * size.height, 0),\\n            () => step(size.width + 5, randomMiddle() * size.height, r180),\\n          ];\\n          if (size.width < 500) steps = steps.slice(0, 2);\\n          controls.resume();\\n          stopped.value = false;\\n        };\\n\\n        start.value();\\n      });\\n\\n      const mask = computed(\\n        () => 'radial-gradient(circle, transparent, black);',\\n      );\\n\\n      return {\\n        size,\\n        el,\\n        mask,\\n        start,\\n        stopped,\\n      };\\n    },\\n    mounted() {},\\n    methods: {},\\n\\n    template: getTemplate('$:/plugins/oeyoews/vue-plum/templates/app.vue'),\\n  };\\n  return component;\\n};\\n\\nmodule.exports = app;\\n\",\"type\":\"application/javascript\",\"module-type\":\"library\"},\"$:/plugins/oeyoews/vue-plum/pageTemplate\":{\"title\":\"$:/plugins/oeyoews/vue-plum/pageTemplate\",\"tags\":\"$:/tags/PageTemplate\",\"text\":\"<$vue-plum />\"},\"$:/plugins/oeyoews/vue-plum/widget.js\":{\"title\":\"$:/plugins/oeyoews/vue-plum/widget.js\",\"text\":\"/*\\\\\\ntitle: $:/plugins/oeyoews/vue-plum/widget.js\\ntype: application/javascript\\nmodule-type: widget\\n\\nvue-plum widget\\n\\n\\\\*/\\nconst { widget: Widget } = require('$:/core/modules/widgets/widget.js');\\n\\nclass PlumWidget extends Widget {\\n  constructor(parseTreeNode, options) {\\n    super(parseTreeNode, options);\\n  }\\n\\n  render(parent, nextSibling) {\\n    if (!$tw.browser) return;\\n\\n    this.computeAttributes();\\n    this.execute();\\n\\n    const ssr = this.document.isTiddlyWikiFakeDom;\\n    if (ssr) return;\\n\\n    const vuelib = '$:/plugins/oeyoews/neotw-vue3/vue.global.prod.js';\\n\\n    if (!window.Vue) {\\n      window.Vue = require(vuelib);\\n    }\\n\\n    const { createApp } = window.Vue;\\n    const component = require('./app');\\n    const domNode = this.document.createElement('div');\\n\\n    try {\\n      const app = createApp(component());\\n\\n      app.config.errorHandler = (err) => {\\n        const text = `[Vue3](${app.version}): ` + err;\\n        console.error(text);\\n        domNode.textContent = text;\\n        domNode.style.color = 'red';\\n      };\\n\\n      // 挂载\\n      app.mount(domNode);\\n\\n      parent.insertBefore(domNode, nextSibling);\\n      this.domNodes.push(domNode);\\n    } catch (e) {\\n      console.error(e.message);\\n    }\\n  }\\n}\\n\\n/** @description vue-plum widget */\\nexports['vue-plum'] = PlumWidget;\\n\",\"type\":\"application/javascript\",\"module-type\":\"widget\"}}}"}