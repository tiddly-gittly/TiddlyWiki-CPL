{"author":"whitefall","core-version":">=5.2.0","dependents":"$:/plugins/tiddlywiki/markdown $:/plugins/kookma/shiraz-callout","description":"从 Obsidian 笔记库导入 Markdown 文件到 TiddlyWiki","list":"readme ui/Panel ui/settings","name":"Obsidian Vault","plugin-type":"plugin","text":"{\"tiddlers\":{\"$:/config/markdown/breaks\":{\"title\":\"$:/config/markdown/breaks\",\"created\":\"20230915033254554\",\"modified\":\"20230915033254554\",\"type\":\"text/vnd.tiddlywiki\",\"text\":\"true\"},\"$:/plugins/whitefall/obsidian-vault/readme\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/readme\",\"type\":\"text/vnd.tiddlywiki\",\"text\":\"! tw5-obsidian-vault\\n\\n使用方式请查看：[[参考手册|https://tiddly-gittly.github.io/tidgi-obsidian-manager/]]\\n\\nGithub Repo: https://github.com/tiddly-gittly/tidgi-obsidian-manager\"},\"$:/plugins/whitefall/obsidian-vault/router/get-obvault.js\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/router/get-obvault.js\",\"text\":\"!function(){\\\"use strict\\\";exports.method=\\\"GET\\\",exports.path=/^\\\\/obvault\\\\/(.+)$/,exports.handler=function(t,e,m){var y=require(\\\"path\\\"),h=require(\\\"fs\\\"),i=$tw.utils.decodeURIComponentSafe(m.params[0]),n=m.queryParameters,b=function(t,e){return t=t.replace(/\\\\\\\\/g,\\\"/\\\"),(e=e.replace(/\\\\\\\\/g,\\\"/\\\")).slice(t.length+1)},i=function(t,e,i){var i=i||[\\\".git\\\",\\\".obsidian\\\"],n={vaultname:t.split(\\\"/\\\").pop()||\\\"-\\\",mds:[],ims:[]},s=e||\\\"\\\";if(!h.statSync(t).isDirectory())return m.sendResponse(400,{\\\"Content-Type\\\":\\\"text/plain\\\"},\\\"Not folder: \\\"+t),null;for(var r=[t];0!==r.length;){var a=r.pop();for(const c of h.readdirSync(a)){var o,p,d,l,u,f,g=y.join(a,c);h.statSync(g).isFile()?(p=c.lastIndexOf(\\\".\\\"),o=c.substring(0,p),p=c.substring(p+1),l=h.statSync(g),-1!==[\\\"jpg\\\",\\\"jpeg\\\",\\\"png\\\",\\\"gif\\\",\\\"bmp\\\",\\\"svg\\\"].indexOf(p)&&(d=g.lastIndexOf(\\\".\\\"),d=g.substring(0,d),n.ims.push({relpath:b(t,d),data:h.readFileSync(g).toString(\\\"base64\\\"),created:$tw.utils.stringifyDate(l.birthtime),modified:$tw.utils.stringifyDate(l.mtime),basename:o,extension:p})),\\\"md\\\"===p&&(d=g.lastIndexOf(\\\".\\\"),l=g.substring(0,d),u=h.readFileSync(g,\\\"utf8\\\"),f=h.statSync(g),RegExp(s).test(u))&&n.mds.push({relpath:b(t,l),data:u,created:$tw.utils.stringifyDate(f.birthtime),modified:$tw.utils.stringifyDate(f.mtime),basename:o,extension:p})):i.includes(c)||r.push(g)}}return n}(i,n.regText,n.ignore);0!=i&&(n=JSON.stringify(i),m.sendResponse(200,{\\\"Content-Type\\\":\\\"application/json\\\"},n))}}();\",\"type\":\"application/javascript\",\"module-type\":\"route\"},\"$:/plugins/whitefall/obsidian-vault/stylesheet/obsidian-main-style\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/stylesheet/obsidian-main-style\",\"tags\":\"$:/tags/Stylesheet\",\"type\":\"text/css\",\"text\":\".obvault-control-panel td{padding:4px}.obvault-control-panel table,.obvault-control-panel table input,.obvault-control-panel table textarea{width:100%}.list-obvault-scroll-container{border:2px solid #ccc;border-radius:5px;height:100px;max-height:200px;overflow-y:scroll}\"},\"$:/plugins/whitefall/obsidian-vault/ui/Panel\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/ui/Panel\",\"type\":\"text/vnd.tiddlywiki\",\"tags\":\"$:/tags/ControlPanel/SettingsTab\",\"caption\":\"obvault-Panel\",\"text\":\"\\n<$obvault/>\\n<div class=\\\"obvault-control-panel\\\">\\n<table>\\n    <tr>\\n        <th>Vault 文件夹路径</th>\\n    </tr>\\n    <tr>\\n        <td><$edit-text tiddler=\\\"$:/temp/obsidian-vault/input-box-path\\\" size=\\\"48\\\" type=\\\"text\\\" tag=\\\"input\\\" default=\\\"\\\" placeholder=\\\"请输入路径\\\" focus={{$:/plugins/whitefall/obsidian-vault/config/AutoFocus}} /></td>\\n    </tr>\\n</table>\\n\\n<table>\\n  <tr>\\n    <th>选中文件</th>\\n    <th>排除文件夹</th>\\n  </tr>\\n  <tr>\\n    <td><$edit-text tiddler=\\\"$:/temp/obsidian-vault/input-box-reg\\\" type=\\\"text\\\" tag=\\\"input\\\" default=\\\"\\\" placeholder=\\\"请输入表达式\\\" focus={{$:/plugins/whitefall/obsidian-vault/config/AutoFocus}} /></td>\\n    <td><$edit-text tiddler=\\\"$:/temp/obsidian-vault/input-box-ignore\\\" type=\\\"text\\\" tag=\\\"input\\\" default=\\\"\\\" placeholder=\\\"请输入表达式\\\" focus={{$:/plugins/whitefall/obsidian-vault/config/AutoFocus}} /></td>\\n  </tr>\\n</table>\\n</div>\\n\\n\\n<$set name='path' tiddler='$:/temp/obsidian-vault/input-box-path'>\\n<$set name='reg' tiddler='$:/temp/obsidian-vault/input-box-reg'>\\n<$set name='ignore' tiddler='$:/temp/obsidian-vault/input-box-ignore'>\\n  <$button><$action-sendmessage $message=\\\"tw-obsidian-add\\\" path=<<path>> reg=<<reg>> ignore=<<ignore>> />add</$button>\\n  <$button><$action-sendmessage $message=\\\"tw-obsidian-purge\\\" />purge</$button>\\n</$set>\\n</$set>\\n</$set>\\n\\n<details>\\n  <summary>Vault List</summary>\\n  <div class=\\\"list-obvault-scroll-container\\\">\\n    <$list filter=\\\"[get[obvault]unique[]]\\\" variable=\\\"list-obvault\\\">\\n      <div class=\\\"list-obvault-container\\\">\\n        <input type=\\\"text\\\" value=<<list-obvault>> disabled=\\\"disabled\\\">\\n        <$button><$action-sendmessage $message=\\\"tw-obsidian-sync\\\" obvault=<<list-obvault>> />Sync</$button>\\n        <$button><$action-sendmessage $message=\\\"tw-obsidian-delete\\\" obvault=<<list-obvault>> />Delete</$button>\\n      </div>\\n    </$list>\\n  </div>\\n  <$link to=\\\"$:/plugins/whitefall/obsidian-vault/status/vault-rw-config\\\">vault-rw-config</$link>\\n</details>\\n\"},\"$:/plugins/whitefall/obsidian-vault/ui/displayCaption\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/ui/displayCaption\",\"text\":\"\\\\whitespace trim\\n<h2 class=\\\"tc-title\\\">\\n{{!!caption}}\\n</h2>\"},\"$:/plugins/whitefall/obsidian-vault/ui/displayCaptionFilter\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/ui/displayCaptionFilter\",\"tags\":\"$:/tags/ViewTemplateTitleFilter\",\"list-before\":\"$:/config/ViewTemplateTitleFilters/default\",\"text\":\"[<currentTiddler>has[obvault]has[caption]then[$:/plugins/whitefall/obsidian-vault/ui/displayCaption]]\"},\"$:/plugins/whitefall/obsidian-vault/ui/settings\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/ui/settings\",\"tags\":\"$:/tags/ControlPanel/SettingsTab\",\"caption\":\"obvault settings\",\"text\":\"<$checkbox tiddler=\\\"$:/config/markdown/breaks\\\" field=\\\"text\\\" checked=\\\"true\\\" unchecked=\\\"false\\\" default=\\\"true\\\"> [[Breaks|$:/config/markdown/breaks]], 适配obsidian风格硬换行格式, 需要刷新页面后生效。</$checkbox> \\n\"},\"$:/plugins/whitefall/obsidian-vault/ui/vaulttrees\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/ui/vaulttrees\",\"tags\":\"$:/tags/SideBar\",\"caption\":\"VaultTrees\",\"text\":\"\\n<div class=\\\"tc-tree-obv\\\">\\n<span><center><p>Vault<sup><$link to=\\\"$:/plugins/whitefall/obsidian-vault/ui/Panel\\\">p</$link></sup>&nbsp;文件列表</p></center></span>\\n<<tree prefix:\\\"λ:/\\\">>\\n</div>\\n\\n<!-- \\n[get[obvault]unique[]]\\n[field:obvault[Neural-Networks]get[vaulttree]]\\n条目名必须和字段路径中的名字一致。\\n-->\\n\"},\"$:/plugins/whitefall/obsidian-vault/obvault-main.js\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/obvault-main.js\",\"type\":\"application/javascript\",\"module-type\":\"widget\",\"Modern.TiddlyDev#Origin\":\"obvault-main.ts\",\"text\":\"\\\"use strict\\\";var import_widget=require(\\\"$:/core/modules/widgets/widget.js\\\");function tm_notify(t,e){$tw.wiki.addTiddler({title:\\\"$:/state/notification/\\\"+t,text:t+\\\": \\\"+e}),$tw.notifier.display(\\\"$:/state/notification/\\\"+t)}async function fetchData(t,e,i){var a,n=[\\\".git\\\",\\\".obsidian\\\",\\\".stfolder\\\",\\\".stversions\\\"],n=(\\\"\\\"===i&&(a=JSON.stringify(n)),\\\"\\\"===i&&\\\"+\\\"!==i.at(0)||(l=i.substring(1).replace(/[ ]/g,\\\"\\\").split(\\\",\\\"),a=JSON.stringify(n.concat(l))),\\\"\\\"!==i&&\\\"+\\\"!==i.at(0)&&(l=i.replace(/[ ]/g,\\\"\\\").split(\\\",\\\"),a=JSON.stringify(l)),$tw.wiki.getTiddlerText(\\\"$:/info/url/full\\\")),l=n+\\\"obvault/\\\"+t+`?regText=${e}&ignore=`+a,n=(console.log(\\\"获取数据: \\\"+l),tm_notify(\\\"获取数据: \\\",`\\\"${l.toString()}\\\"`),await fetch(l));if(400!=n.status)return a=await n.json(),console.log(\\\"获取完成, 正在写入到wiki中。\\\"),tm_notify(\\\"获取数据: \\\",\\\"获取完成, 正在写入到wiki中\\\"),a;tm_notify(\\\"获取数据: \\\",\\\"Not Folder\\\")}function isUrl(t){return new RegExp(\\\"^(?!mailto:)(?:(?:http|https|ftp)://|//)(?:\\\\\\\\S+(?::\\\\\\\\S*)?@)?(?:(?:(?:[1-9]\\\\\\\\d?|1\\\\\\\\d\\\\\\\\d|2[01]\\\\\\\\d|22[0-3])(?:\\\\\\\\.(?:1?\\\\\\\\d{1,2}|2[0-4]\\\\\\\\d|25[0-5])){2}(?:\\\\\\\\.(?:[0-9]\\\\\\\\d?|1\\\\\\\\d\\\\\\\\d|2[0-4]\\\\\\\\d|25[0-4]))|(?:(?:[a-z\\\\\\\\u00a1-\\\\\\\\uffff0-9]+-?)*[a-z\\\\\\\\u00a1-\\\\\\\\uffff0-9]+)(?:\\\\\\\\.(?:[a-z\\\\\\\\u00a1-\\\\\\\\uffff0-9]+-?)*[a-z\\\\\\\\u00a1-\\\\\\\\uffff0-9]+)*(?:\\\\\\\\.(?:[a-z\\\\\\\\u00a1-\\\\\\\\uffff]{2,})))|localhost)(?::\\\\\\\\d{2,5})?(?:(/|\\\\\\\\?|#)[^\\\\\\\\s]*)?$\\\",\\\"i\\\").test(t)}function is_simple_link(t,e){let i=0;for(const n in t.mds){var a=t.mds[n][\\\"relpath\\\"];(a.includes(\\\"/\\\")?a.split(\\\"/\\\").slice(-1)[0]:a)===e&&(i+=1)}return 1==i||!(2<=i)&&null}function find_simple_link(t,e){for(const a in t.mds){var i=t.mds[a][\\\"relpath\\\"];if(i.includes(\\\"/\\\")){if(i.split(\\\"/\\\").slice(-1)[0]===e)return i}else if(i===e)return i}}function links_wiki_syntax(t,e){var i={ob_pattern:new RegExp(\\\"(?<!!)\\\\\\\\[\\\\\\\\[(.*?)\\\\\\\\]\\\\\\\\]\\\",\\\"g\\\"),md_pattern:new RegExp(\\\"(?<!!)\\\\\\\\[(.*?)\\\\\\\\]\\\\\\\\((.*?)\\\\\\\\)\\\",\\\"g\\\")},a=[...e.matchAll(i.ob_pattern)];for(const d in a){var n=a[d][0],l=a[d][1],r=l.split(\\\"|\\\"),s=r[0];if(1===r.length){if(isUrl(s))break;s.includes(\\\"/\\\")||(e=is_simple_link(t,l)?e.replace(n,`[[${s}|λ:/${t.vaultname}/${find_simple_link(t,s)}]]`):e.replace(n,`[[${s}|λ:/${t.vaultname}/${s}]]`)),s.includes(\\\"/\\\")&&(e=e.replace(n,`[[${s.split(\\\"/\\\").slice(-1)}|λ:/${t.vaultname}/${s}]]`))}2<=r.length&&(r=r[1],isUrl(s)?e=e.replace(n,`[[${r}|${s}]]`):(s.includes(\\\"/\\\")||(e=is_simple_link(t,l)?e.replace(n,`[[${r}|λ:/${t.vaultname}/${find_simple_link(t,s)}]]`):e.replace(n,`[[${r}|λ:/${t.vaultname}/${s}]]`)),s.includes(\\\"/\\\")&&(e=e.replace(n,`[[${r}|λ:/${t.vaultname}/${s}]]`))))}return e}function embeds_im_syntax(t,e){const i=/\\\\!\\\\[\\\\[(.*?)\\\\]\\\\]/g,a=/\\\\!\\\\[(.*?)\\\\]\\\\((.*?)\\\\)/g;var n=[\\\"jpg\\\",\\\"jpeg\\\",\\\"png\\\",\\\"gif\\\",\\\"bmp\\\",\\\"svg\\\"],l=[...e.matchAll(i)],r=[...e.matchAll(a)];for(const p in l){var s=l[p][0],d=l[p][1].split(\\\"|\\\"),o=d[0],u=o.split(\\\".\\\").slice(-1)[0];-1!==n.indexOf(u)?(1==d.length&&(e=e.replace(s,`[img [${o.trim()}]]`)),2<=d.length&&\\\"number\\\"==typeof(u=+d.slice(-1)[0])&&(e=e.replace(s,`[img width=${u} [${o.trim()}]]`))):o.includes(\\\"/\\\")||(e=is_simple_link(t,o)?e.replace(s,`{{λ:/${t.vaultname}/${find_simple_link(t,o.trim())}}}`):e.replace(s,`{{λ:/${t.vaultname}/${o.trim()}}}`))}for(const w in r){var c=r[w][0],f=r[w][1],g=r[w][2],f=f.split(\\\"|\\\"),m=f[0];0!==f.length&&\\\"\\\"!==m.trim()||(e=e.replace(c,`[img [${g}]]`)),1===f.length&&(e=e.replace(c,`[img [${m.trim()}|${g}]]`)),2<=f.length&&\\\"number\\\"==typeof(f=+f.slice(-1)[0].split(\\\"x\\\")[0])&&(e=e.replace(c,`[img width=${f} [${m.trim()}|${g}]]`))}return e}function bold_wiki_syntax(t){return t=t.replace(/\\\\x20*\\\\*\\\\*(.*?)\\\\*\\\\*\\\\x20*/g,\\\" **$1** \\\")}function shiraz_callout_syntax(t){var e=[...t.matchAll(/^(> .+\\\\n?)+$/gm)];for(const r in e)var i=e[r][0],a=i.split(\\\">\\\"),n=a.splice(0,2).join(\\\"\\\"),a=a.join(\\\"\\\"),l=[],n=(n.includes(\\\"]\\\\n\\\")?(n=n.trim(),l.push(n)):((n=n.trim()).includes(\\\"-\\\")&&(l=n.split(\\\"- \\\")),n.includes(\\\"-\\\")||(l.push(n.slice(0,n.indexOf(\\\" \\\")+1).trim()),l.push(n.slice(n.indexOf(\\\" \\\")+1)))),l[0].substring(2,l[0].length-1).toLowerCase()),l=2==l.length?l[1]:\\\"\\\",t=t.replace(i,`<<callout type:\\\"${n}\\\" title:\\\"${l}\\\" src:\\\"${a}\\\">>`);return t}async function convert(t,e){return e=void 0!==e&&0!==e.length?shiraz_callout_syntax(e=bold_wiki_syntax(e=links_wiki_syntax(t,e=embeds_im_syntax(t,e)))):e}async function addVault(t){console.log(\\\"vaultName: \\\"+t.vaultname);var e=$tw.wiki.getTiddlerText(\\\"$:/status/UserName\\\");console.log(t);for(const u in t.mds){var{relpath:i,data:a,created:n,modified:l,basename:r}=t.mds[u],a=await convert(t,a),i=`λ:/${t.vaultname}/`+i;$tw.wiki.addTiddler(new $tw.Tiddler({title:i,type:\\\"text/markdown\\\",caption:r,created:n,modified:l,modifier:e,text:a,obvault:t.vaultname}))}for(const c in t.ims){var{data:s,basename:d,extension:o}=t.ims[c];$tw.wiki.addTiddler(new $tw.Tiddler({title:d+\\\".\\\"+o,type:\\\"image/\\\"+o,text:s,obvault:t.vaultname}))}console.log(\\\"addVault: 所有添加工作已完成。\\\"),tm_notify(\\\"addVault\\\",\\\"所有添加工作已完成，请等待【文件系统同步服务】完成任务。\\\")}async function purgeVault(t){var e;console.log(\\\"purgeVault: \\\"+t),\\\"\\\"!==t&&(e=$tw.wiki.filterTiddlers(`[field:obvault[${t}]]`),tm_notify(\\\"purgeVault\\\",`正在清空${t}Vault`),await deleteTiddler(e)),void 0!==t&&\\\"\\\"!==t||await deleteTiddler($tw.wiki.filterTiddlers(\\\"[has:field[obvault]]\\\"))}async function deleteTiddler(t){0!==t.length?(t.forEach(t=>{console.log(\\\"删除条目：\\\"+t),$tw.wiki.deleteTiddler(t)}),tm_notify(\\\"purgeVault\\\",\\\"所有删除工作已完成, 请等待【文件系统同步服务】完成任务。\\\")):tm_notify(\\\"purgeVault\\\",\\\"未曾添加Obsidian仓库, 写入记录为空。\\\")}var CONFIG_FILE=\\\"$:/plugins/whitefall/obsidian-vault/status/vault-rw-config\\\";function getConfig(){var t=$tw.wiki.getTiddlerText(CONFIG_FILE);if(void 0===t)return{};try{return JSON.parse(t)}catch(e){return console.log(\\\"解析JSON失败, 不是正确的JSON格式!\\\"),console.log(e),$tw.wiki.deleteTiddler(CONFIG_FILE),{}}}function addConfig(t){var e={...getConfig(),...t};$tw.wiki.addTiddler(new $tw.Tiddler({title:CONFIG_FILE,text:JSON.stringify(e)}))}function getConfigJSON(){return getConfig()}function deleteConfig(t){var e=$tw.wiki.getTiddlerText(CONFIG_FILE);void 0!==e&&(delete(e=JSON.parse(e))[t],$tw.wiki.addTiddler(new $tw.Tiddler({title:CONFIG_FILE,text:JSON.stringify(e)}))),void 0!==t&&\\\"\\\"!==t||$tw.wiki.deleteTiddler(CONFIG_FILE)}var ObVaultServer=class{constructor(){$tw.rootWidget.addEventListener(\\\"tw-obsidian-add\\\",async t=>{await this.getAndWrite(t.paramObject.path,t.paramObject.reg,t.paramObject.ignore)}),$tw.rootWidget.addEventListener(\\\"tw-obsidian-purge\\\",async t=>{purgeVault(),deleteConfig()}),$tw.rootWidget.addEventListener(\\\"tw-obsidian-sync\\\",async t=>{var e=t.paramObject.obvault,i=getConfigJSON();\\\"{}\\\"!==JSON.stringify(i)?(console.log(\\\"开始更新Vault。\\\"),tm_notify(\\\"Vault-Sync\\\",\\\"开始更新Vault。\\\"),purgeVault(e),await this.getAndWrite(i[e].path,i[e].reg,i[e].ignore)):(console.log(\\\"更新失败, CONFIG_FILE为空。重新添加Vault后, 将自动生成记录\\\"),tm_notify(\\\"Vault-Sync\\\",\\\"更新失败, CONFIG_FILE为空。重新添加Vault后, 将自动生成记录\\\"))}),$tw.rootWidget.addEventListener(\\\"tw-obsidian-delete\\\",async t=>{var e=t.paramObject.obvault;console.log(\\\"删除Vault: \\\"+e),tm_notify(\\\"Vault-Delete\\\",\\\"删除Vault: \\\"+e),purgeVault(e),deleteConfig(e)})}async getAndWrite(t,e,i){var a,n,l;this.isValidPath(t)&&(a=await fetchData(t,e,i),n={},l=this.getFolderName(t),void 0!==a)&&(n[l]={path:t,reg:e,ignore:i},addVault(a),addConfig(n))}isValidPath(t){return\\\"\\\"===t?(console.log(\\\"路径为空！\\\"),tm_notify(\\\"addVault\\\",\\\"路径为空！\\\"),!1):!!/^(\\\\/|\\\\.\\\\.?\\\\/|([A-Za-z]:)?[\\\\\\\\|\\\\/])[^\\\\\\\\|\\\\/]+([\\\\\\\\|\\\\/][^\\\\\\\\|\\\\/]+)*[\\\\\\\\|\\\\/]?$/.test(t)||(console.log(\\\"无效路径！\\\"),tm_notify(\\\"addVault\\\",\\\"无效路径！\\\"),!1)}getFolderName(t){var e=t.lastIndexOf(\\\"/\\\"),i=t.lastIndexOf(\\\"\\\\\\\\\\\"),e=Math.max(e,i);return e<0?t:t.substring(e+1)}},ObVaultWidget=class extends import_widget.widget{refresh(t){this.computeAttributes();return!1}async render(t,e){this.parentDomNode=t,this.execute();new ObVaultServer}};exports.obvault=ObVaultWidget;\"}}}","title":"$:/plugins/whitefall/obsidian-vault","type":"application/json","version":"0.1.6","Modern.TiddlyDev#SHA256-Hashed":"0166334a7759b69c133ed4124b2becfdac7115845578204ef98ca7f8398156b8"}