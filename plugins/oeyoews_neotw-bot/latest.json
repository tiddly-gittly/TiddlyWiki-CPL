{"title":"$:/plugins/oeyoews/neotw-bot","description":"向Telegram bot 发送消息","author":"oeyoews","version":"0.0.1","core-version":">=5.3.0","type":"application/json","plugin-type":"plugin","name":"neotw-bot","meat#disabled":"yes","qrcode":"yes","created":"2024/08-11","dependents":"$:/plugins/oeyoews/neotw-vue3 $:/plugins/oeyoews/tiddlywiki-tailwindcss-plus","stability":"STABILITY_1_STABLE","list":"readme","text":"{\"tiddlers\":{\"$:/plugins/oeyoews/neotw-bot/templates/app.vue\":{\"text\":\"<template>\\n  <el-form @submit.native.prevent>\\n    <el-form-item>\\n      <el-mention :options=\\\"actionOptions\\\" type='textarea' :autosize=\\\"{ minRows: 4, maxRows: 10 }\\\" placeholder='请输入内容*'\\n        v-model=\\\"text\\\"></el-mention>\\n    </el-form-item>\\n  </el-form>\\n  <div class=\\\"flex gap-1\\\">\\n    <el-input placeholder='你的昵称' v-model=\\\"username\\\"></el-input>\\n    <el-mention :options=\\\"emailSuffixOptions\\\" placeholder='你的邮箱*' v-model.trim=\\\"email\\\"></el-mention>\\n    <!-- 做成弹窗 -->\\n    <el-select v-model=\\\"version\\\" placeholder=\\\"选择版本\\\">\\n      <el-option v-for=\\\"item in versions\\\" :key=\\\"item\\\" :label=\\\"item\\\" :value=\\\"item\\\">\\n      </el-option>\\n    </el-select>\\n    <el-upload accept=\\\"image/*\\\" :auto-upload=\\\"false\\\" :on-change=\\\"handleSuccess\\\" :show-file-list=\\\"false\\\">\\n      <el-button>上传</el-button>\\n    </el-upload>\\n    <el-button @click=\\\"sendMessage\\\">\\n      发送\\n    </el-button>\\n  </div>\\n</template>\",\"title\":\"$:/plugins/oeyoews/neotw-bot/templates/app.vue\",\"hide-body\":\"yes\"},\"$:/plugins/oeyoews/neotw-bot/plugins/TiddlyWikiVue.js\":{\"text\":\"module.exports={install(t,o){t.component(\\\"TiddlyWikiVue\\\",{template:\\\"<button> {{ msg }} </button>\\\",props:{msg:String}})}};\",\"title\":\"$:/plugins/oeyoews/neotw-bot/plugins/TiddlyWikiVue.js\",\"module-type\":\"library\",\"type\":\"application/javascript\"},\"$:/plugins/oeyoews/neotw-bot/components/Version.js\":{\"text\":\"module.exports={name:\\\"Version\\\",props:{version:{type:String,default:\\\"5.3.2\\\"}},template:\\\"<span> {{ version }} </span>\\\"};\",\"title\":\"$:/plugins/oeyoews/neotw-bot/components/Version.js\",\"module-type\":\"library\",\"type\":\"application/javascript\"},\"$:/plugins/oeyoews/neotw-bot/readme\":{\"title\":\"$:/plugins/oeyoews/neotw-bot/readme\",\"description\":\"neotw-bot\",\"text\":\"[[在线文档|https://neotw.vercel.app/docs/plugins/neotw-bot]]\"},\"$:/plugins/oeyoews/neotw-bot/app.js\":{\"title\":\"$:/plugins/oeyoews/neotw-bot/app.js\",\"text\":\"/*\\\\\\ntitle: $:/plugins/oeyoews/neotw-bot/app.js\\ntype: application/javascript\\nmodule-type: library\\n\\n\\\\*/\\nconst{ElNotification:t}=require(\\\"element-plus.min.js\\\"),e=require(\\\"../neotw-vue3/getTemplate.js\\\");module.exports=({token:s})=>{const i={components:{},template:e(\\\"$:/plugins/oeyoews/neotw-bot/templates/app.vue\\\"),data:()=>({baseUrl:\\\"https://api.telegram.org/bot\\\"+s,chatId:\\\"\\\",username:\\\"\\\",email:\\\"\\\",text:\\\"\\\",hasToken:!1,version:\\\"\\\",latestTwVersion:\\\"\\\",versions:[],file:\\\"\\\",actionOptions:[\\\"photo\\\"].map((t=>({label:t,value:t}))),emailSuffixOptions:[\\\"gmail.com\\\",\\\"outlook.com\\\",\\\"163.com\\\",\\\"qq.com\\\",\\\"126.com\\\"].map((t=>({label:t,value:t})))}),mounted(){this.getTWLatestVersion().then((()=>{this.generateRandomVersion()})),this.checkToken(s),this.hasToken=this.getChatId()},methods:{handleSuccess(e){this.file=e?.raw,this.caption=e?.name||\\\"\\\",t({title:\\\"成功\\\",message:e.name+\\\"文件上传本地成功\\\",type:\\\"success\\\"})},checkToken(e){if(!e)return t({title:\\\"错误\\\",message:\\\"请输入token\\\",type:\\\"warning\\\"}),!1;if(!/^\\\\d+:[A-Za-z0-9_-]+$/.test(e))return t({title:\\\"错误\\\",message:\\\"token 无效\\\",type:\\\"warning\\\"}),!1;const s=e.split(\\\":\\\"),i=s[0],n=s[1];return 10===i.length&&35===n.length||(t({title:\\\"错误\\\",message:\\\"token 无效\\\",type:\\\"warning\\\"}),!1)},checkEmail:e=>!!/^[A-Za-z0-9\\\\u4e00-\\\\u9fa5]+@[a-zA-Z0-9_-]+(\\\\.[a-zA-Z0-9_-]+)+$/.test(e)||(t({title:\\\"错误\\\",message:\\\"email 无效\\\",type:\\\"warning\\\"}),!1),generateRandomVersion(){function t(){return Math.random().toFixed(1).split(\\\".\\\")[1]}Array(3).fill(0).forEach((()=>{this.versions.push(`v${t()}.${t()}.${t()}`)})),this.versions.splice(Math.floor(Math.random()*(this.versions.length+1)),0,this.latestTwVersion)},getTWLatestVersion(){return new Promise(((t,e)=>{fetch(\\\"https://api.github.com/repos/TiddlyWiki/TiddlyWiki5/tags\\\").then((t=>t.json())).then((e=>{this.latestTwVersion=e[0].name,t()}))}))},sendPhoto(){const e=this.text.trim();if(e.startsWith(\\\"@photo \\\")){const t=e.split(\\\" \\\")[e.split(\\\" \\\").length-1];t.startsWith(\\\"http\\\")&&(this.file=t,this.text=\\\"\\\")}if(!this.file)return;const s=new FormData;s.append(\\\"chat_id\\\",this.chatId),this.caption&&s.append(\\\"caption\\\",this.caption),s.append(\\\"photo\\\",this.file),fetch(this.baseUrl+\\\"/sendPhoto\\\",{method:\\\"POST\\\",body:s}).then((t=>t.json())).then((e=>{this.file=\\\"\\\",this.caption=\\\"\\\",e.ok?t({title:\\\"成功\\\",message:\\\"图片发送成功\\\",type:\\\"success\\\"}):t({type:\\\"error\\\",message:e.description,title:\\\"错误\\\"})})).catch((e=>{t({type:\\\"error\\\",message:e,title:\\\"错误\\\"})}))},sendMessage(){if(this.sendPhoto(),!this.checkToken(s))return void t({title:\\\"错误\\\",message:\\\"token 无效\\\",type:\\\"warning\\\"});if(!this.text||!this.username||!this.email)return void t({title:\\\"错误\\\",message:\\\"请完善表单信息\\\",type:\\\"warning\\\"});if(!this.checkEmail(this.email))return void t({title:\\\"错误\\\",message:\\\"Email格式不正确\\\",type:\\\"warning\\\"});if(this.version!==this.latestTwVersion)return void t({title:\\\"错误\\\",message:\\\"验证未通过，请选择正确的版本号\\\",type:\\\"warning\\\"});const e={chat_id:this.chatId,text:`username: ${this.username}\\\\nemail: ${this.email}\\\\ncontent: ${this.text}`};fetch(this.baseUrl+\\\"/sendMessage\\\",{method:\\\"POST\\\",headers:{\\\"Content-Type\\\":\\\"application/json\\\"},body:JSON.stringify(e)}).then((t=>t.json())).then((e=>{e.ok?(this.text=\\\"\\\",t({title:\\\"成功\\\",message:\\\"发送成功\\\",type:\\\"success\\\",duration:1500})):t({title:\\\"错误(tg-bot)\\\",message:e.description,type:\\\"error\\\"})})).catch((e=>{t({title:\\\"错误\\\",message:e.description,type:\\\"error\\\"})}))},async getChatId(){try{const t=await fetch(this.baseUrl+\\\"/getUpdates\\\"),e=await t.json();this.chatId=e.result[0].my_chat_member.chat.id}catch(t){console.log(t)}}}};return i};\",\"type\":\"application/javascript\",\"module-type\":\"library\"},\"$:/plugins/oeyoews/neotw-bot/widget.js\":{\"title\":\"$:/plugins/oeyoews/neotw-bot/widget.js\",\"text\":\"/*\\\\\\ntitle: $:/plugins/oeyoews/neotw-bot/widget.js\\ntype: application/javascript\\nmodule-type: widget\\n\\nneotw-bot widget\\n\\n\\\\*/\\nconst{widget:e}=require(\\\"$:/core/modules/widgets/widget.js\\\");exports[\\\"tg-bot\\\"]=class extends e{constructor(e,t){super(e,t)}render(e,t){if(!$tw.browser)return;if(this.computeAttributes(),this.execute(),this.document.isTiddlyWikiFakeDom)return;const r=require(\\\"element-plus.min.js\\\");window.Vue||(window.Vue=require(\\\"$:/plugins/oeyoews/neotw-vue3/vue.global.prod.js\\\"));const{tiddler:s}=this.attributes,{createApp:o}=window.Vue,i=require(\\\"./app\\\"),n=this.document.createElement(\\\"div\\\");try{\\n/** @type {{ use: Function, component: (string, Object) }} */\\nconst u=o(i({token:$tw.wiki.getTiddlerText(s)||\\\"\\\"}));u.use(r),u.config.errorHandler=e=>{const t=`[Vue3](${u.version}): `+e.message;console.error(t),n.textContent=t,n.style.color=\\\"red\\\"},u.mount(n),e.insertBefore(n,t),this.domNodes.push(n)}catch(e){console.error(e.message)}}refresh(){return!1}};\",\"type\":\"application/javascript\",\"module-type\":\"widget\"}}}"}