{"Modern.TiddlyDev#ExternalModules":"fsevents","author":"LinOnetwo","core-version":">=5.1.22","dependents":"$:/plugins/twcloud/tiddlyweb-sse","description":"Reload changed tiddlers from disc filesystem","list":"readme","plugin-type":"plugin","stability":"STABILITY_1_EXPERIMENTAL","text":"{\"tiddlers\":{\"$:/plugins/linonetwo/watch-fs/readme\":{\"title\":\"$:/plugins/linonetwo/watch-fs/readme\",\"creator\":\"LinOnetwo\",\"type\":\"text/vnd.tiddlywiki\",\"text\":\"!! About\\n\\nThis plugin enables TiddlyWiki to watch the change in your disk, and if you edit one of your tiddler using text editor likes VSCode / Typora and save it on the disk, the change will immediately reflected in the browser / TidGi Desktop.\\n\\nSee [[https://github.com/Jermolene/TiddlyWiki5/issues/3060]] for related discussions.\\n\\n!! [[FileSystemMonitor.js|$:/plugins/linonetwo/watch-fs/FileSystemMonitor.js]]\\n\\nThis module watches the file system in the tiddlers folder and any changes to\\nthe files in the folder that don't come from the browser are reported to the\\nbrowser. So if you make a new .tid file in the tiddlers folder it will appear\\nin the wiki in the browser without needing to restart the server. You can also\\ndelete files to remove the tiddlers from the browser.\\n\\n!! Installation\\n\\nFrom [[CPL - Watch FS|https://tw-cpl.netlify.app/#Plugin_202310110932256]] or from [[Github Release|https://github.com/tiddly-gittly/watch-fs/releases]].\\n\\n!! Usage\\n\\nUsually, it works after install (and a reload).\\n\\nBut see limitations below if you want to build blog in Github Actions.\\n\\n!! Liminitation\\n\\n# can't handle rename in the disk, you can only rename from within the wiki (no such API to tell tw I've renamed a file)\\n# I haven't tested this with [[$:/config/FileSystemPaths]] and [[Fix file info PR|https://github.com/Jermolene/TiddlyWiki5/pull/4630]] , but I use this feature every day, so I will definitely support it.\\n# Can't handle if git change the tiddler while you are open its Draft tiddler (might be fixed by [[Deleting a draft tiddler should not also delete the original tiddler|https://github.com/Jermolene/TiddlyWiki5/issues/4792]] )\\n\\n!!! Can't build wiki blog\\n\\nThis plugin will cause trouble if you build wiki with it enabled,\\nso you have to remove it from your `tiddlywiki.info`, and add it to your wiki start arguments:\\n\\n```shell\\ntiddlywiki +plugins/tiddlywiki/filesystem +plugins/tiddlywiki/tiddlyweb +plugins/linonetwo/watch-fs <path-to-wiki-folder> --listen\\n```\\n\\n(why `+plugins/tiddlywiki/filesystem +plugins/tiddlywiki/tiddlyweb` here? See [[https://github.com/Jermolene/TiddlyWiki5/issues/4484#issuecomment-613200370]] for details)\\n\\n!!! Using on network share / NFS\\n\\nIf the files are mounted from a remote, you will most likely use polling instead of the OS-native watcher.\\nThis is not done automaticly, since there is really no way for us to detect that.\\n\\nIf your files are on a remote, you should set the environment-variable `CHOKIDAR_USEPOLLING=1`.\\nYou can also configure the polling interval (default 100ms) using `CHOKIDAR_INTERVAL`.\\n\\n!! Implementation Details\\n\\n!!! How to decide whether a change is comes from the browser?\\n\\nWe will compare disk file and wiki file, if there is any discrepancy,\\nthen we know the change is not made from the wiki, it is made by git or VSCode, in this case we read data from the disc,\\nand add data to the tiddlywiki.\\n\\n!!! How to sync changes to the browser?\\n\\nwe can't trigger sync from the server, so we have to set a smaller sync interval in the client side.\\n\\nSo this plugin ship with a large [[$:/config/SyncPollingInterval]] to disable the build-in sync,\\nand we add a new route `/linonetwo/watch-fs-can-sync` to the simple server, it will return `true` or `false`,\\nand browser will poll this route, to see if it needs to trigger a `$tw.syncer.syncFromServer()`.\\n\"},\"$:/plugins/linonetwo/watch-fs/FileSystemMonitor.js\":{\"title\":\"$:/plugins/linonetwo/watch-fs/FileSystemMonitor.js\",\"type\":\"application/javascript\",\"module-type\":\"library\",\"Modern.TiddlyDev#Origin\":\"FileSystemMonitor.ts\",\"text\":\"\\\"use strict\\\";var __create=Object.create,__defProp=Object.defineProperty,__defProps=Object.defineProperties,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropDescs=Object.getOwnPropertyDescriptors,__getOwnPropNames=Object.getOwnPropertyNames,__getOwnPropSymbols=Object.getOwnPropertySymbols,__getProtoOf=Object.getPrototypeOf,__hasOwnProp=Object.prototype.hasOwnProperty,__propIsEnum=Object.prototype.propertyIsEnumerable,__defNormalProp=(e,t,i)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,__spreadValues=(e,t)=>{for(var i in t=t||{})__hasOwnProp.call(t,i)&&__defNormalProp(e,i,t[i]);if(__getOwnPropSymbols)for(var i of __getOwnPropSymbols(t))__propIsEnum.call(t,i)&&__defNormalProp(e,i,t[i]);return e},__spreadProps=(e,t)=>__defProps(e,__getOwnPropDescs(t)),__objRest=(e,t)=>{var i={};for(r in e)__hasOwnProp.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&__getOwnPropSymbols)for(var r of __getOwnPropSymbols(e))t.indexOf(r)<0&&__propIsEnum.call(e,r)&&(i[r]=e[r]);return i},__export=(e,t)=>{for(var i in t)__defProp(e,i,{get:t[i],enumerable:!0})},__copyProps=(t,i,r,o)=>{if(i&&\\\"object\\\"==typeof i||\\\"function\\\"==typeof i)for(let e of __getOwnPropNames(i))__hasOwnProp.call(t,e)||e===r||__defProp(t,e,{get:()=>i[e],enumerable:!(o=__getOwnPropDesc(i,e))||o.enumerable});return t},__toESM=(e,t,i)=>(i=null!=e?__create(__getProtoOf(e)):{},__copyProps(!t&&e&&e.__esModule?i:__defProp(i,\\\"default\\\",{value:e,enumerable:!0}),e)),__toCommonJS=e=>__copyProps(__defProp({},\\\"__esModule\\\",{value:!0}),e),FileSystemMonitor_exports={},import_fs=(__export(FileSystemMonitor_exports,{FileSystemMonitor:()=>FileSystemMonitor}),module.exports=__toCommonJS(FileSystemMonitor_exports),__toESM(require(\\\"fs\\\"))),import_path2=__toESM(require(\\\"path\\\"));function isTiddlerField(e){return\\\"object\\\"==typeof e&&null!==e}var fieldsToCount=[\\\"bag\\\",\\\"revision\\\"];function deepEqual(e,t){if(e===t)return!0;if(titleListEqual(e,t))return!0;if(timeStampEqual(e,t))return!0;if(isTiddlerField(e)&&isTiddlerField(t)){var i,r,o=countRuntimeFieldsFromTiddler(e),s=countRuntimeFieldsFromTiddler(t);if(Object.keys(e).length-o!=Object.keys(t).length-s)return!1;for([i,r]of Object.entries(e))if(!fieldsToCount.includes(i)&&!deepEqual(r,null==t?void 0:t[i]))return!1;return!0}return!1}function titleListEqual(e,t){return\\\"string\\\"==typeof e&&Array.isArray(t)?$tw.utils.stringifyList(t)===e:!(\\\"string\\\"!=typeof t||!Array.isArray(e))&&$tw.utils.stringifyList(e)===t}function timeStampEqual(e,t){return\\\"object\\\"==typeof t&&null!=t&&t.toString&&0===Object.keys(t).length&&\\\"string\\\"==typeof e?JSON.stringify(t).replace(/[\\\".:TZ-]/g,\\\"\\\")===e:\\\"object\\\"==typeof e&&null!=e&&e.toString&&0===Object.keys(e).length&&\\\"string\\\"==typeof t?JSON.stringify(e).replace(/[\\\".:TZ-]/g,\\\"\\\")===t:\\\"string\\\"==typeof e&&\\\"string\\\"==typeof t&&(e.replace(/[.:TZ-]/g,\\\"\\\")===t||t.replace(/[.:TZ-]/g,\\\"\\\")===e)}function countRuntimeFieldsFromTiddler(e){let t=0;for(const i of fieldsToCount)i in e&&(t+=1);return t}var import_path=__toESM(require(\\\"path\\\"));function pad(e){return e<10?\\\"0\\\".concat(e):String(e)}function toTWUTCString(e){return\\\"\\\".concat(e.getUTCFullYear()).concat(pad(e.getUTCMonth()+1)).concat(pad(e.getUTCDate())).concat(pad(e.getUTCHours())).concat(pad(e.getUTCMinutes())).concat(pad(e.getUTCSeconds())).concat((e.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5))}function safeStringifyHugeTiddler(e,t){return\\\"tid\\\"===t?JSON.stringify(e,void 0,\\\"  \\\"):\\\"tiddlers\\\"in e&&Array.isArray(e.tiddlers)?JSON.stringify(__spreadProps(__spreadValues({},e),{tiddlers:e.tiddlers.map(e=>{var t;return __spreadProps(__spreadValues({},e),{text:(null==(t=e.text)?void 0:t.length)<1e3?e.text:\\\"\\\".concat(null==(t=null==e?void 0:e.text)?void 0:t.substring(0,1e3),\\\"\\\\n\\\\n--more-log-ignored-by-watch-fs-plugin--\\\")})})}),void 0,\\\"  \\\").substring(0,2e3):JSON.stringify(e,void 0,\\\"  \\\").substring(0,1e3)}function getTwCustomMimeType(e){var t=$tw.utils.getFileExtensionInfo(e);let i=t?t.type:\\\"\\\";return i=\\\"text/markdown\\\"===i?\\\"text/x-markdown\\\":i}var chokidar=require(\\\"$:/plugins/linonetwo/watch-fs/chokidar.js\\\")[\\\"default\\\"],FileSystemMonitor=class{constructor(){var e;this.isDebug=!0,this.debugLog=()=>{},this.initialLoadedFiles={},this.inverseFilesIndex={},this.lockedFiles=new Set,this.chokidar=chokidar,this.debugLog=this.isDebug?(...e)=>console.log(\\\"[watch-fs]\\\",...e):()=>{},this.watchPathBase=import_path2[\\\"default\\\"].resolve((null==(e=null==(e=$tw.boot.wikiInfo)?void 0:e.config)?void 0:e.watchFolder)||$tw.boot.wikiTiddlersPath||\\\"./tiddlers\\\"),this.debugLog(\\\"watchPathBase\\\",JSON.stringify(this.watchPathBase,void 0,\\\"  \\\")),this.watcher=chokidar.watch(this.watchPathBase,{ignoreInitial:!0,ignored:[\\\"**/*.meta\\\",\\\"**/$__StoryList*\\\",\\\"**/*_1.*\\\",\\\"**/subwiki/**\\\",\\\"**/.DS_Store\\\",\\\"**/.git\\\"],atomic:!0}),this.setupListeners()}updateInverseIndex(e,t){t?this.inverseFilesIndex[e]=t:delete this.inverseFilesIndex[e]}filePathExistsInIndex(e){return Boolean(this.inverseFilesIndex[e])}getTitleByPath(e){try{return this.inverseFilesIndex[e].tiddlerTitle}catch(t){throw this.watcher.close(),new Error(\\\"\\\".concat(e,\\\"\\\\n↑ not existed in watch-fs plugin's FileSystemMonitor's this.inverseFilesIndex\\\"))}}getPathByTitle(e){try{for(const i in this.inverseFilesIndex)if(this.inverseFilesIndex[i].tiddlerTitle===e||this.inverseFilesIndex[i].tiddlerTitle===\\\"\\\".concat(e,\\\".tid\\\"))return i;throw new Error(\\\"getPathByTitle\\\")}catch(t){throw this.watcher.close(),new Error(\\\"\\\".concat(e,\\\"\\\\n↑ not existed in watch-fs plugin's FileSystemMonitor's this.inverseFilesIndex\\\"))}}initializeInverseFilesIndex(){this.initialLoadedFiles=$tw.boot.files;for(const i in this.initialLoadedFiles){var e,t;!{}.hasOwnProperty.call(this.initialLoadedFiles,i)||(e=this.initialLoadedFiles[i],t=import_path2[\\\"default\\\"].relative(this.watchPathBase,e.filepath),this.inverseFilesIndex[t]=__spreadProps(__spreadValues({},e),{filepath:t,tiddlerTitle:i}))}}setupListeners(){this.initializeInverseFilesIndex();this.watcher.on(\\\"all\\\",(o,e,t)=>{const s=import_path2[\\\"default\\\"].relative(this.watchPathBase,e);var n=import_path2[\\\"default\\\"].join(this.watchPathBase,s),d=\\\"\\\".concat(n,\\\".meta\\\"),l=import_path2[\\\"default\\\"].basename(n),a=import_path2[\\\"default\\\"].parse(n).name,c=import_path2[\\\"default\\\"].extname(s),u=getTwCustomMimeType(c);if(this.debugLog(\\\"\\\".concat(s,\\\" \\\").concat(o)),\\\".meta\\\"!==c)if(this.lockedFiles.has(s))this.debugLog(\\\"\\\".concat(s,\\\" ignored due to mutex lock\\\")),this.lockedFiles[\\\"delete\\\"](s);else{if(\\\"add\\\"===o||\\\"change\\\"===o){let e;try{e=$tw.loadTiddlersFromFile(n)}catch(f){return void this.debugLog(f)}var p=[\\\"tid\\\",\\\"json\\\",\\\"meta\\\"];\\\"add\\\"===o&&!import_fs[\\\"default\\\"].existsSync(d)&&!p.includes(c.slice(1))&&(p=toTWUTCString(new Date),this.debugLog(\\\"Adding meta file \\\".concat(d,\\\" using mime type \\\").concat(u)),import_fs[\\\"default\\\"].writeFileSync(d,\\\"caption: \\\".concat(a,\\\"\\\\ncreated: \\\").concat(p,\\\"\\\\nmodified: \\\").concat(p,\\\"\\\\ntitle: \\\").concat(l,\\\"\\\\ntype: \\\").concat(u,\\\"\\\\n\\\")),import_fs[\\\"default\\\"].unlinkSync(n),import_fs[\\\"default\\\"].unlinkSync(d)),this.debugLog(\\\"tiddlersDescriptor\\\",safeStringifyHugeTiddler(e,c));let t=e,i=t.tiddlers,r=__objRest(t,[\\\"tiddlers\\\"]);this.filePathExistsInIndex(s)?i.filter(e=>{this.debugLog(\\\"updating existed tiddler\\\",e.title);var t=null==(t=$tw.wiki.getTiddler(e.title))?void 0:t.fields;if(void 0!==t){if(deepEqual(e,t))return this.debugLog(\\\"Ignore update due to detect this is a change from the Browser\\\",e.title),!1;if(e.modified&&t.modified&&t.modified>e.modified)return this.debugLog(\\\"Ignore update due to there is latest change from the Browser\\\",e.title),!1;this.debugLog(\\\"Saving updated\\\",e.title)}return!0}).forEach(e=>{$tw.syncadaptor.wiki.addTiddler(e)}):i.forEach(e=>{this.debugLog(\\\"getting new tiddler.title\\\",e.title);var t=$tw.wiki.getTiddler(e.title);t&&deepEqual(e,t.fields)?(this.debugLog(\\\"deepEqual with existed tiddler, tiddler.title: \\\",e.title),this.updateInverseIndex(s,__spreadProps(__spreadValues({},r),{tiddlerTitle:e.title}))):(this.debugLog(\\\"get new addTiddler tiddler.title\\\",e.title),this.updateInverseIndex(s,__spreadProps(__spreadValues({},r),{tiddlerTitle:e.title})),$tw.syncadaptor.wiki.addTiddler(e))})}if(\\\"unlink\\\"===o){a=this.getTitleByPath(s),p=$tw.wiki.getTiddler(a);if(this.debugLog(\\\"existedTiddlerResult\\\",p&&safeStringifyHugeTiddler(p,c)),p){this.lockedFiles.add(s),this.debugLog(\\\"trying to delete\\\",n),$tw.syncadaptor.removeTiddlerFileInfo(a);try{n.startsWith(\\\"$\\\")&&import_fs[\\\"default\\\"].existsSync(n)&&0===import_fs[\\\"default\\\"].readFileSync(n,\\\"utf-8\\\").length&&import_fs[\\\"default\\\"].unlinkSync(n)}catch(f){console.error(f)}}else this.debugLog(\\\"file already deleted by wiki\\\",n);this.updateInverseIndex(s,void 0)}}})}};\"},\"$:/plugins/linonetwo/watch-fs/chokidar.js\":{\"title\":\"$:/plugins/linonetwo/watch-fs/chokidar.js\",\"type\":\"application/javascript\",\"module-type\":\"library\",\"Modern.TiddlyDev#Origin\":\"chokidar.ts\",\"text\":\"\\\"use strict\\\";var __create=Object.create,__defProp=Object.defineProperty,__defProps=Object.defineProperties,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropDescs=Object.getOwnPropertyDescriptors,__getOwnPropNames=Object.getOwnPropertyNames,__getOwnPropSymbols=Object.getOwnPropertySymbols,__getProtoOf=Object.getPrototypeOf,__hasOwnProp=Object.prototype.hasOwnProperty,__propIsEnum=Object.prototype.propertyIsEnumerable,__defNormalProp=(t,e,s)=>e in t?__defProp(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,__spreadValues=(t,e)=>{for(var s in e=e||{})__hasOwnProp.call(e,s)&&__defNormalProp(t,s,e[s]);if(__getOwnPropSymbols)for(var s of __getOwnPropSymbols(e))__propIsEnum.call(e,s)&&__defNormalProp(t,s,e[s]);return t},__spreadProps=(t,e)=>__defProps(t,__getOwnPropDescs(e)),__export=(t,e)=>{for(var s in e)__defProp(t,s,{get:e[s],enumerable:!0})},__copyProps=(e,s,i,r)=>{if(s&&\\\"object\\\"==typeof s||\\\"function\\\"==typeof s)for(let t of __getOwnPropNames(s))__hasOwnProp.call(e,t)||t===i||__defProp(e,t,{get:()=>s[t],enumerable:!(r=__getOwnPropDesc(s,t))||r.enumerable});return e},__toESM=(t,e,s)=>(s=null!=t?__create(__getProtoOf(t)):{},__copyProps(!e&&t&&t.__esModule?s:__defProp(s,\\\"default\\\",{value:t,enumerable:!0}),t)),__toCommonJS=t=>__copyProps(__defProp({},\\\"__esModule\\\",{value:!0}),t),chokidar_exports={},import_fs2=(__export(chokidar_exports,{\\\"default\\\":()=>chokidar_default}),module.exports=__toCommonJS(chokidar_exports),require(\\\"fs\\\")),import_promises3=require(\\\"fs/promises\\\"),import_events=require(\\\"events\\\"),sysPath2=__toESM(require(\\\"path\\\"),1),import_promises=require(\\\"fs/promises\\\"),import_stream=require(\\\"stream\\\"),import_path=require(\\\"path\\\");function defaultOptions(){return{root:\\\".\\\",fileFilter:t=>!0,directoryFilter:t=>!0,type:FILE_TYPE,lstat:!1,depth:2147483648,alwaysStat:!1,highWaterMark:4096}}var RECURSIVE_ERROR_CODE=\\\"READDIRP_RECURSIVE_ERROR\\\",NORMAL_FLOW_ERRORS=new Set([\\\"ENOENT\\\",\\\"EPERM\\\",\\\"EACCES\\\",\\\"ELOOP\\\",RECURSIVE_ERROR_CODE]),FILE_TYPE=\\\"files\\\",DIR_TYPE=\\\"directories\\\",FILE_DIR_TYPE=\\\"files_directories\\\",EVERYTHING_TYPE=\\\"all\\\",ALL_TYPES=[FILE_TYPE,DIR_TYPE,FILE_DIR_TYPE,EVERYTHING_TYPE],DIR_TYPES=new Set([DIR_TYPE,FILE_DIR_TYPE,EVERYTHING_TYPE]),FILE_TYPES=new Set([FILE_TYPE,FILE_DIR_TYPE,EVERYTHING_TYPE]),isNormalFlowError=t=>NORMAL_FLOW_ERRORS.has(t.code),wantBigintFsStats=\\\"win32\\\"===process.platform,emptyFn=t=>!0,normalizeFilter=t=>{if(void 0!==t){if(\\\"function\\\"==typeof t)return t;if(\\\"string\\\"==typeof t){const e=t.trim();return t=>t.basename===e}if(Array.isArray(t)){const s=t.map(t=>t.trim());return e=>s.some(t=>e.basename===t)}}return emptyFn},ReaddirpStream=class extends import_stream.Readable{constructor(t={}){super({objectMode:!0,autoDestroy:!0,highWaterMark:t.highWaterMark});var e=__spreadValues(__spreadValues({},defaultOptions()),t),{root:s,type:i}=e;this._fileFilter=normalizeFilter(e.fileFilter),this._directoryFilter=normalizeFilter(e.directoryFilter);const r=e.lstat?import_promises.lstat:import_promises.stat;this._stat=wantBigintFsStats?t=>r(t,{bigint:!0}):r,this._maxDepth=e.depth,this._wantsDir=DIR_TYPES.has(i),this._wantsFile=FILE_TYPES.has(i),this._wantsEverything=i===EVERYTHING_TYPE,this._root=(0,import_path.resolve)(s),this._isDirent=!e.alwaysStat,this._statsProp=this._isDirent?\\\"dirent\\\":\\\"stats\\\",this._rdOptions={encoding:\\\"utf8\\\",withFileTypes:this._isDirent},this.parents=[this._exploreDir(s,1)],this.reading=!1,this.parent=void 0}async _read(s){if(!this.reading){this.reading=!0;try{for(;!this.destroyed&&0<s;){var i=this.parent,r=i&&i.files;if(r&&0<r.length){let{path:e,depth:t}=i;var a=r.splice(0,s).map(t=>this._formatEntry(t,e));for(const h of await Promise.all(a)){if(!h)return void s--;if(this.destroyed)return;var o=await this._getEntryType(h);\\\"directory\\\"===o&&this._directoryFilter(h)?(t<=this._maxDepth&&this.parents.push(this._exploreDir(h.fullPath,t+1)),this._wantsDir&&(this.push(h),s--)):(\\\"file\\\"===o||this._includeAsFile(h))&&this._fileFilter(h)&&this._wantsFile&&(this.push(h),s--)}}else{var t=this.parents.pop();if(!t){this.push(null);break}if(this.parent=await t,this.destroyed)return}}}catch(e){this.destroy(e)}finally{this.reading=!1}}}async _exploreDir(t,e){let s;try{s=await(0,import_promises.readdir)(t,this._rdOptions)}catch(i){this._onError(i)}return{files:s,depth:e,path:t}}async _formatEntry(t,e){let s;var i=this._isDirent?t.name:t;try{var r=(0,import_path.resolve)((0,import_path.join)(e,i));(s={path:(0,import_path.relative)(this._root,r),fullPath:r,basename:i})[this._statsProp]=this._isDirent?t:await this._stat(r)}catch(a){return void this._onError(a)}return s}_onError(t){isNormalFlowError(t)&&!this.destroyed?this.emit(\\\"warn\\\",t):this.destroy(t)}async _getEntryType(t){if(!t&&this._statsProp in t)return\\\"\\\";var e=t[this._statsProp];if(e.isFile())return\\\"file\\\";if(e.isDirectory())return\\\"directory\\\";if(e&&e.isSymbolicLink()){e=t.fullPath;try{var s,i,r=await(0,import_promises.realpath)(e),a=await(0,import_promises.lstat)(r);return a.isFile()?\\\"file\\\":a.isDirectory()?(s=r.length,e.startsWith(r)&&e.substr(s,1)===import_path.sep?((i=new Error('Circular symlink detected: \\\"'.concat(e,'\\\" points to \\\"').concat(r,'\\\"'))).code=RECURSIVE_ERROR_CODE,this._onError(i)):\\\"directory\\\"):void 0}catch(o){return this._onError(o),\\\"\\\"}}}_includeAsFile(t){var e=t&&t[this._statsProp];return e&&this._wantsEverything&&!e.isDirectory()}},readdirp=(t,e={})=>{let s=e.entryType||e.type;if((s=\\\"both\\\"===s?FILE_DIR_TYPE:s)&&(e.type=s),!t)throw new Error(\\\"readdirp: root argument is required. Usage: readdirp(root, options)\\\");if(\\\"string\\\"!=typeof t)throw new TypeError(\\\"readdirp: root argument must be a string. Usage: readdirp(root, options)\\\");if(s&&!ALL_TYPES.includes(s))throw new Error(\\\"readdirp: Invalid type passed. Use one of \\\".concat(ALL_TYPES.join(\\\", \\\")));return e.root=t,new ReaddirpStream(e)},import_fs=require(\\\"fs\\\"),import_promises2=require(\\\"fs/promises\\\"),sysPath=__toESM(require(\\\"path\\\"),1),import_os=require(\\\"os\\\"),STR_DATA=\\\"data\\\",STR_END=\\\"end\\\",STR_CLOSE=\\\"close\\\",EMPTY_FN=()=>{},pl=process.platform,isWindows=\\\"win32\\\"===pl,isMacos=\\\"darwin\\\"===pl,isLinux=\\\"linux\\\"===pl,isFreeBSD=\\\"freebsd\\\"===pl,isIBMi=\\\"OS400\\\"===(0,import_os.type)(),EVENTS={ALL:\\\"all\\\",READY:\\\"ready\\\",ADD:\\\"add\\\",CHANGE:\\\"change\\\",ADD_DIR:\\\"addDir\\\",UNLINK:\\\"unlink\\\",UNLINK_DIR:\\\"unlinkDir\\\",RAW:\\\"raw\\\",ERROR:\\\"error\\\"},EV=EVENTS,THROTTLE_MODE_WATCH=\\\"watch\\\",statMethods={lstat:import_promises2.lstat,stat:import_promises2.stat},KEY_LISTENERS=\\\"listeners\\\",KEY_ERR=\\\"errHandlers\\\",KEY_RAW=\\\"rawEmitters\\\",HANDLER_KEYS=[KEY_LISTENERS,KEY_ERR,KEY_RAW],binaryExtensions=new Set([\\\"3dm\\\",\\\"3ds\\\",\\\"3g2\\\",\\\"3gp\\\",\\\"7z\\\",\\\"a\\\",\\\"aac\\\",\\\"adp\\\",\\\"afdesign\\\",\\\"afphoto\\\",\\\"afpub\\\",\\\"ai\\\",\\\"aif\\\",\\\"aiff\\\",\\\"alz\\\",\\\"ape\\\",\\\"apk\\\",\\\"appimage\\\",\\\"ar\\\",\\\"arj\\\",\\\"asf\\\",\\\"au\\\",\\\"avi\\\",\\\"bak\\\",\\\"baml\\\",\\\"bh\\\",\\\"bin\\\",\\\"bk\\\",\\\"bmp\\\",\\\"btif\\\",\\\"bz2\\\",\\\"bzip2\\\",\\\"cab\\\",\\\"caf\\\",\\\"cgm\\\",\\\"class\\\",\\\"cmx\\\",\\\"cpio\\\",\\\"cr2\\\",\\\"cur\\\",\\\"dat\\\",\\\"dcm\\\",\\\"deb\\\",\\\"dex\\\",\\\"djvu\\\",\\\"dll\\\",\\\"dmg\\\",\\\"dng\\\",\\\"doc\\\",\\\"docm\\\",\\\"docx\\\",\\\"dot\\\",\\\"dotm\\\",\\\"dra\\\",\\\"DS_Store\\\",\\\"dsk\\\",\\\"dts\\\",\\\"dtshd\\\",\\\"dvb\\\",\\\"dwg\\\",\\\"dxf\\\",\\\"ecelp4800\\\",\\\"ecelp7470\\\",\\\"ecelp9600\\\",\\\"egg\\\",\\\"eol\\\",\\\"eot\\\",\\\"epub\\\",\\\"exe\\\",\\\"f4v\\\",\\\"fbs\\\",\\\"fh\\\",\\\"fla\\\",\\\"flac\\\",\\\"flatpak\\\",\\\"fli\\\",\\\"flv\\\",\\\"fpx\\\",\\\"fst\\\",\\\"fvt\\\",\\\"g3\\\",\\\"gh\\\",\\\"gif\\\",\\\"graffle\\\",\\\"gz\\\",\\\"gzip\\\",\\\"h261\\\",\\\"h263\\\",\\\"h264\\\",\\\"icns\\\",\\\"ico\\\",\\\"ief\\\",\\\"img\\\",\\\"ipa\\\",\\\"iso\\\",\\\"jar\\\",\\\"jpeg\\\",\\\"jpg\\\",\\\"jpgv\\\",\\\"jpm\\\",\\\"jxr\\\",\\\"key\\\",\\\"ktx\\\",\\\"lha\\\",\\\"lib\\\",\\\"lvp\\\",\\\"lz\\\",\\\"lzh\\\",\\\"lzma\\\",\\\"lzo\\\",\\\"m3u\\\",\\\"m4a\\\",\\\"m4v\\\",\\\"mar\\\",\\\"mdi\\\",\\\"mht\\\",\\\"mid\\\",\\\"midi\\\",\\\"mj2\\\",\\\"mka\\\",\\\"mkv\\\",\\\"mmr\\\",\\\"mng\\\",\\\"mobi\\\",\\\"mov\\\",\\\"movie\\\",\\\"mp3\\\",\\\"mp4\\\",\\\"mp4a\\\",\\\"mpeg\\\",\\\"mpg\\\",\\\"mpga\\\",\\\"mxu\\\",\\\"nef\\\",\\\"npx\\\",\\\"numbers\\\",\\\"nupkg\\\",\\\"o\\\",\\\"odp\\\",\\\"ods\\\",\\\"odt\\\",\\\"oga\\\",\\\"ogg\\\",\\\"ogv\\\",\\\"otf\\\",\\\"ott\\\",\\\"pages\\\",\\\"pbm\\\",\\\"pcx\\\",\\\"pdb\\\",\\\"pdf\\\",\\\"pea\\\",\\\"pgm\\\",\\\"pic\\\",\\\"png\\\",\\\"pnm\\\",\\\"pot\\\",\\\"potm\\\",\\\"potx\\\",\\\"ppa\\\",\\\"ppam\\\",\\\"ppm\\\",\\\"pps\\\",\\\"ppsm\\\",\\\"ppsx\\\",\\\"ppt\\\",\\\"pptm\\\",\\\"pptx\\\",\\\"psd\\\",\\\"pya\\\",\\\"pyc\\\",\\\"pyo\\\",\\\"pyv\\\",\\\"qt\\\",\\\"rar\\\",\\\"ras\\\",\\\"raw\\\",\\\"resources\\\",\\\"rgb\\\",\\\"rip\\\",\\\"rlc\\\",\\\"rmf\\\",\\\"rmvb\\\",\\\"rpm\\\",\\\"rtf\\\",\\\"rz\\\",\\\"s3m\\\",\\\"s7z\\\",\\\"scpt\\\",\\\"sgi\\\",\\\"shar\\\",\\\"snap\\\",\\\"sil\\\",\\\"sketch\\\",\\\"slk\\\",\\\"smv\\\",\\\"snk\\\",\\\"so\\\",\\\"stl\\\",\\\"suo\\\",\\\"sub\\\",\\\"swf\\\",\\\"tar\\\",\\\"tbz\\\",\\\"tbz2\\\",\\\"tga\\\",\\\"tgz\\\",\\\"thmx\\\",\\\"tif\\\",\\\"tiff\\\",\\\"tlz\\\",\\\"ttc\\\",\\\"ttf\\\",\\\"txz\\\",\\\"udf\\\",\\\"uvh\\\",\\\"uvi\\\",\\\"uvm\\\",\\\"uvp\\\",\\\"uvs\\\",\\\"uvu\\\",\\\"viv\\\",\\\"vob\\\",\\\"war\\\",\\\"wav\\\",\\\"wax\\\",\\\"wbmp\\\",\\\"wdp\\\",\\\"weba\\\",\\\"webm\\\",\\\"webp\\\",\\\"whl\\\",\\\"wim\\\",\\\"wm\\\",\\\"wma\\\",\\\"wmv\\\",\\\"wmx\\\",\\\"woff\\\",\\\"woff2\\\",\\\"wrm\\\",\\\"wvx\\\",\\\"xbm\\\",\\\"xif\\\",\\\"xla\\\",\\\"xlam\\\",\\\"xls\\\",\\\"xlsb\\\",\\\"xlsm\\\",\\\"xlsx\\\",\\\"xlt\\\",\\\"xltm\\\",\\\"xltx\\\",\\\"xm\\\",\\\"xmind\\\",\\\"xpi\\\",\\\"xpm\\\",\\\"xwd\\\",\\\"xz\\\",\\\"z\\\",\\\"zip\\\",\\\"zipx\\\"]),isBinaryPath=t=>binaryExtensions.has(sysPath.extname(t).slice(1).toLowerCase()),foreach=(t,e)=>{t instanceof Set?t.forEach(e):e(t)},addAndConvert=(t,e,s)=>{let i=t[e];i instanceof Set||(t[e]=i=new Set([i])),i.add(s)},clearItem=s=>t=>{var e=s[t];e instanceof Set?e.clear():delete s[t]},delFromSet=(t,e,s)=>{var i=t[e];i instanceof Set?i[\\\"delete\\\"](s):i===s&&delete t[e]},isEmptySet=t=>t instanceof Set?0===t.size:!t,FsWatchInstances=new Map;function createFsWatchInstance(s,t,i,e,r){try{return(0,import_fs.watch)(s,{persistent:t.persistent},(t,e)=>{i(s),r(t,e,{watchedPath:s}),e&&s!==e&&fsWatchBroadcast(sysPath.resolve(s,e),KEY_LISTENERS,sysPath.join(s,e))})}catch(a){e(a)}}var fsWatchBroadcast=(t,e,s,i,r)=>{var a=FsWatchInstances.get(t);a&&foreach(a[e],t=>{t(s,i,r)})},setFsWatchListener=(i,r,t,e)=>{let{listener:s,errHandler:a,rawEmitter:o}=e,h=FsWatchInstances.get(r),n;if(!t.persistent)return(n=createFsWatchInstance(i,t,s,a,o))?n.close.bind(n):void 0;if(h)addAndConvert(h,KEY_LISTENERS,s),addAndConvert(h,KEY_ERR,a),addAndConvert(h,KEY_RAW,o);else{if(!(n=createFsWatchInstance(i,t,fsWatchBroadcast.bind(null,r,KEY_LISTENERS),a,fsWatchBroadcast.bind(null,r,KEY_RAW))))return;n.on(EV.ERROR,async t=>{var e=fsWatchBroadcast.bind(null,r,KEY_ERR);if(h&&(h.watcherUnusable=!0),isWindows&&\\\"EPERM\\\"===t.code)try{await(await(0,import_promises2.open)(i,\\\"r\\\")).close(),e(t)}catch(s){}else e(t)}),h={listeners:s,errHandlers:a,rawEmitters:o,watcher:n},FsWatchInstances.set(r,h)}return()=>{delFromSet(h,KEY_LISTENERS,s),delFromSet(h,KEY_ERR,a),delFromSet(h,KEY_RAW,o),isEmptySet(h.listeners)&&(h.watcher.close(),FsWatchInstances[\\\"delete\\\"](r),HANDLER_KEYS.forEach(clearItem(h)),h.watcher=void 0,Object.freeze(h))}},FsWatchFileInstances=new Map,setFsWatchFileListener=(i,r,t,e)=>{let{listener:s,rawEmitter:a}=e,o=FsWatchFileInstances.get(r);var h=o&&o.options;return h&&(h.persistent<t.persistent||h.interval>t.interval)&&((0,import_fs.unwatchFile)(r),o=void 0),o?(addAndConvert(o,KEY_LISTENERS,s),addAndConvert(o,KEY_RAW,a)):(o={listeners:s,rawEmitters:a,options:t,watcher:(0,import_fs.watchFile)(r,t,(e,s)=>{foreach(o.rawEmitters,t=>{t(EV.CHANGE,r,{curr:e,prev:s})});var t=e.mtimeMs;(e.size!==s.size||t>s.mtimeMs||0===t)&&foreach(o.listeners,t=>t(i,e))})},FsWatchFileInstances.set(r,o)),()=>{delFromSet(o,KEY_LISTENERS,s),delFromSet(o,KEY_RAW,a),isEmptySet(o.listeners)&&(FsWatchFileInstances[\\\"delete\\\"](r),(0,import_fs.unwatchFile)(r),o.options=o.watcher=void 0,Object.freeze(o))}},NodeFsHandler=class{constructor(e){this.fsw=e,this._boundHandleError=t=>e._handleError(t)}_watchWithNodeFs(t,e){var s,i=this.fsw.options,r=sysPath.dirname(t),a=sysPath.basename(t),r=(this.fsw._getWatchedDir(r).add(a),sysPath.resolve(t)),o={persistent:i.persistent};e=e||EMPTY_FN;let h;return h=i.usePolling?(s=i.interval!==i.binaryInterval,o.interval=s&&isBinaryPath(a)?i.binaryInterval:i.interval,setFsWatchFileListener(t,r,o,{listener:e,rawEmitter:this.fsw._emitRaw})):setFsWatchListener(t,r,o,{listener:e,errHandler:this._boundHandleError,rawEmitter:this.fsw._emitRaw})}_handleFile(d,t,e){if(!this.fsw.closed){const _=sysPath.dirname(d),c=sysPath.basename(d),p=this.fsw._getWatchedDir(_);let l=t;if(!p.has(c)){const m=async(t,e)=>{var s,i;if(this.fsw._throttle(THROTTLE_MODE_WATCH,d,5))if(e&&0!==e.mtimeMs)p.has(c)&&(s=e.atimeMs,i=e.mtimeMs,(!s||s<=i||i!==l.mtimeMs)&&this.fsw._emit(EV.CHANGE,d,e),l=e);else try{var r,a,o,h=await(0,import_promises2.stat)(d);this.fsw.closed||(r=h.atimeMs,a=h.mtimeMs,(!r||r<=a||a!==l.mtimeMs)&&this.fsw._emit(EV.CHANGE,d,h),(isMacos||isLinux||isFreeBSD)&&l.ino!==h.ino?(this.fsw._closeFile(t),l=h,(o=this._watchWithNodeFs(d,m))&&this.fsw._addPathCloser(t,o)):l=h)}catch(n){this.fsw._remove(_,c)}};var s=this._watchWithNodeFs(d,m);if((!e||!this.fsw.options.ignoreInitial)&&this.fsw._isntIgnored(d)){if(!this.fsw._throttle(EV.ADD,d,0))return;this.fsw._emit(EV.ADD,d,t)}return s}}}async _handleSymlink(e,t,s,i){if(!this.fsw.closed){var r=e.fullPath,a=this.fsw._getWatchedDir(t);if(!this.fsw.options.followSymlinks){this.fsw._incrReadyCount();let t;try{t=await(0,import_promises2.realpath)(s)}catch(o){return this.fsw._emitReady(),!0}return this.fsw.closed?void 0:(a.has(i)?this.fsw._symlinkPaths.get(r)!==t&&(this.fsw._symlinkPaths.set(r,t),this.fsw._emit(EV.CHANGE,s,e.stats)):(a.add(i),this.fsw._symlinkPaths.set(r,t),this.fsw._emit(EV.ADD,s,e.stats)),this.fsw._emitReady(),!0)}if(this.fsw._symlinkPaths.has(r))return!0;this.fsw._symlinkPaths.set(r,!0)}}_handleRead(r,a,o,h,n,l,s){if(r=sysPath.join(r,\\\"\\\"),s=this.fsw._throttle(\\\"readdir\\\",r,1e3)){const d=this.fsw._getWatchedDir(o.path),_=new Set;let i=this.fsw._readdirp(r,{fileFilter:t=>o.filterPath(t),directoryFilter:t=>o.filterDir(t)});if(i)return i.on(STR_DATA,async t=>{var e,s;this.fsw.closed?i=void 0:(e=t.path,s=sysPath.join(r,e),_.add(e),t.stats.isSymbolicLink()&&await this._handleSymlink(t,r,s,e)||(this.fsw.closed?i=void 0:e!==h&&(h||d.has(e))||(this.fsw._incrReadyCount(),s=sysPath.join(n,sysPath.relative(n,s)),this._addToNodeFs(s,a,o,l+1))))}).on(EV.ERROR,this._boundHandleError),new Promise((e,t)=>{if(!i)return t();i.once(STR_END,()=>{var t;this.fsw.closed?i=void 0:(t=!!s&&s.clear(),e(void 0),d.getChildren().filter(t=>t!==r&&!_.has(t)).forEach(t=>{this.fsw._remove(r,t)}),i=void 0,t&&this._handleRead(r,!1,o,h,n,l,s))})})}}async _handleDir(s,t,e,i,r,a,o){var h=this.fsw._getWatchedDir(sysPath.dirname(s)),n=h.has(sysPath.basename(s));e&&this.fsw.options.ignoreInitial||r||n||this.fsw._emit(EV.ADD_DIR,s,t),h.add(sysPath.basename(s)),this.fsw._getWatchedDir(s);let l;n=this.fsw.options.depth;if((null==n||i<=n)&&!this.fsw._symlinkPaths.has(o)){if(!r&&(await this._handleRead(s,e,a,r,s,i,void 0),this.fsw.closed))return;l=this._watchWithNodeFs(s,(t,e)=>{e&&0===e.mtimeMs||this._handleRead(t,!1,a,r,s,i,void 0)})}return l}async _addToNodeFs(e,s,i,r,a){var o=this.fsw._emitReady;if(this.fsw._isIgnored(e)||this.fsw.closed)return o(),!1;var h=this.fsw._getWatchHelpers(e);i&&(h.filterPath=t=>i.filterPath(t),h.filterDir=t=>i.filterDir(t));try{var n=await statMethods[h.statMethod](h.watchPath);if(!this.fsw.closed){if(this.fsw._isIgnored(h.watchPath,n))o();else{var l=this.fsw.options.followSymlinks;let t;if(n.isDirectory()){var d=sysPath.resolve(e),_=l?await(0,import_promises2.realpath)(e):e;if(this.fsw.closed)return;if(t=await this._handleDir(h.watchPath,n,s,r,a,h,_),this.fsw.closed)return;d!==_&&void 0!==_&&this.fsw._symlinkPaths.set(d,_)}else if(n.isSymbolicLink()){var c=l?await(0,import_promises2.realpath)(e):e;if(this.fsw.closed)return;var p=sysPath.dirname(h.watchPath);if(this.fsw._getWatchedDir(p).add(h.watchPath),this.fsw._emit(EV.ADD,h.watchPath,n),t=await this._handleDir(p,n,s,r,e,h,c),this.fsw.closed)return;void 0!==c&&this.fsw._symlinkPaths.set(sysPath.resolve(e),c)}else t=this._handleFile(h.watchPath,n,s);o(),t&&this.fsw._addPathCloser(e,t)}return!1}}catch(t){if(this.fsw._handleError(t))return o(),e}}},SLASH=\\\"/\\\",SLASH_SLASH=\\\"//\\\",ONE_DOT=\\\".\\\",TWO_DOTS=\\\"..\\\",STRING_TYPE=\\\"string\\\",BACK_SLASH_RE=/\\\\\\\\/g,DOUBLE_SLASH_RE=/\\\\/\\\\//,DOT_RE=/\\\\..*\\\\.(sw[px])$|~$|\\\\.subl.*\\\\.tmp/,REPLACER_RE=/^\\\\.[/\\\\\\\\]/;function arrify(t){return Array.isArray(t)?t:[t]}var isMatcherObject=t=>\\\"object\\\"==typeof t&&null!==t&&!(t instanceof RegExp);function createPattern(s){return\\\"function\\\"==typeof s?s:\\\"string\\\"==typeof s?t=>s===t:s instanceof RegExp?t=>s.test(t):\\\"object\\\"==typeof s&&null!==s?t=>{var e;return s.path===t||!(!s.recursive||!(e=sysPath2.relative(s.path,t))||e.startsWith(\\\"..\\\")||sysPath2.isAbsolute(e))}:()=>!1}function normalizePath(t){if(\\\"string\\\"!=typeof t)throw new Error(\\\"string expected\\\");let e=!1;(t=(t=sysPath2.normalize(t)).replace(/\\\\\\\\/g,\\\"/\\\")).startsWith(\\\"//\\\")&&(e=!0);for(var s=/\\\\/\\\\//;t.match(s);)t=t.replace(s,\\\"/\\\");return t=e?\\\"/\\\"+t:t}function matchPatterns(t,e,s){var i=normalizePath(e);for(let r=0;r<t.length;r++)if((0,t[r])(i,s))return!0;return!1}function anymatch(t,e){if(null==t)throw new TypeError(\\\"anymatch: specify first argument\\\");const s=arrify(t).map(t=>createPattern(t));return null==e?(t,e)=>matchPatterns(s,t,e):matchPatterns(s,e)}var unifyPaths=t=>{var e=arrify(t).flat();if(e.every(t=>typeof t===STRING_TYPE))return e.map(normalizePathToUnix);throw new TypeError(\\\"Non-string provided as watch path: \\\".concat(e))},toUnix=t=>{let e=t.replace(BACK_SLASH_RE,SLASH),s=!1;for(e.startsWith(SLASH_SLASH)&&(s=!0);e.match(DOUBLE_SLASH_RE);)e=e.replace(DOUBLE_SLASH_RE,SLASH);return e=s?SLASH+e:e},normalizePathToUnix=t=>toUnix(sysPath2.normalize(toUnix(t))),normalizeIgnored=(e=\\\"\\\")=>t=>\\\"string\\\"==typeof t?normalizePathToUnix(sysPath2.isAbsolute(t)?t:sysPath2.join(e,t)):t,getAbsolutePath=(t,e)=>sysPath2.isAbsolute(t)?t:sysPath2.join(e,t),EMPTY_SET=Object.freeze(new Set),DirEntry=class{constructor(t,e){this.path=t,this._removeWatcher=e,this.items=new Set}add(t){var e=this.items;e&&t!==ONE_DOT&&t!==TWO_DOTS&&e.add(t)}async remove(t){var e=this.items;if(e&&(e[\\\"delete\\\"](t),!(0<e.size))){e=this.path;try{await(0,import_promises3.readdir)(e)}catch(s){this._removeWatcher&&this._removeWatcher(sysPath2.dirname(e),sysPath2.basename(e))}}}has(t){var e=this.items;if(e)return e.has(t)}getChildren(){var t=this.items;return t?[...t.values()]:[]}dispose(){this.items.clear(),this.path=\\\"\\\",this._removeWatcher=EMPTY_FN,this.items=EMPTY_SET,Object.freeze(this)}},STAT_METHOD_F=\\\"stat\\\",STAT_METHOD_L=\\\"lstat\\\",WatchHelper=class{constructor(t,e,s){this.fsw=s;var i=t;this.path=t=t.replace(REPLACER_RE,\\\"\\\"),this.watchPath=i,this.fullWatchPath=sysPath2.resolve(i),this.dirParts=[],this.dirParts.forEach(t=>{1<t.length&&t.pop()}),this.followSymlinks=e,this.statMethod=e?STAT_METHOD_F:STAT_METHOD_L}entryPath(t){return sysPath2.join(this.watchPath,sysPath2.relative(this.watchPath,t.fullPath))}filterPath(t){var e,s=t.stats;return s&&s.isSymbolicLink()?this.filterDir(t):(e=this.entryPath(t),this.fsw._isntIgnored(e,s)&&this.fsw._hasReadPermissions(s))}filterDir(t){return this.fsw._isntIgnored(this.entryPath(t),t.stats)}},FSWatcher=class extends import_events.EventEmitter{constructor(t={}){super(),this.closed=!1,this._closers=new Map,this._ignoredPaths=new Set,this._throttled=new Map,this._streams=new Set,this._symlinkPaths=new Map,this._watched=new Map,this._pendingWrites=new Map,this._pendingUnlinks=new Map,this._readyCount=0,this._readyEmitted=!1;var e=t.awaitWriteFinish,s={stabilityThreshold:2e3,pollInterval:100},s=__spreadProps(__spreadValues({persistent:!0,ignoreInitial:!1,ignorePermissionErrors:!1,interval:100,binaryInterval:300,followSymlinks:!0,usePolling:!1,atomic:!0},t),{ignored:t.ignored?arrify(t.ignored):arrify([]),awaitWriteFinish:!0===e?s:\\\"object\\\"==typeof e&&__spreadValues(__spreadValues({},s),e)}),e=(isIBMi&&(s.usePolling=!0),void 0===s.atomic&&(s.atomic=!s.usePolling),process.env.CHOKIDAR_USEPOLLING),e=(void 0!==e&&(e=e.toLowerCase(),s.usePolling=\\\"false\\\"!==e&&\\\"0\\\"!==e&&(\\\"true\\\"===e||\\\"1\\\"===e||!!e)),process.env.CHOKIDAR_INTERVAL);e&&(s.interval=Number.parseInt(e,10));let i=0;this._emitReady=()=>{++i>=this._readyCount&&(this._emitReady=EMPTY_FN,this._readyEmitted=!0,process.nextTick(()=>this.emit(EVENTS.READY)))},this._emitRaw=(...t)=>this.emit(EVENTS.RAW,...t),this._boundRemove=this._remove.bind(this),this.options=s,this._nodeFsHandler=new NodeFsHandler(this),Object.freeze(s)}_addIgnoredPath(t){if(isMatcherObject(t))for(const e of this._ignoredPaths)if(isMatcherObject(e)&&e.path===t.path&&e.recursive===t.recursive)return;this._ignoredPaths.add(t)}_removeIgnoredPath(t){if(this._ignoredPaths[\\\"delete\\\"](t),\\\"string\\\"==typeof t)for(const e of this._ignoredPaths)isMatcherObject(e)&&e.path===t&&this._ignoredPaths[\\\"delete\\\"](e)}add(t,s,i){let e=this.options.cwd,r=(this.closed=!1,this._closePromise=void 0,unifyPaths(t));return(r=e?r.map(t=>getAbsolutePath(t,e)):r).forEach(t=>{this._removeIgnoredPath(t)}),this._userIgnored=void 0,this._readyCount||(this._readyCount=0),this._readyCount+=r.length,Promise.all(r.map(async t=>{var e=await this._nodeFsHandler._addToNodeFs(t,!i,void 0,0,s);return e&&this._emitReady(),e})).then(t=>{this.closed||t.forEach(t=>{t&&this.add(sysPath2.dirname(t),sysPath2.basename(s||t))})}),this}unwatch(t){if(!this.closed){var s=unifyPaths(t);let e=this.options.cwd;s.forEach(t=>{sysPath2.isAbsolute(t)||this._closers.has(t)||(e&&(t=sysPath2.join(e,t)),t=sysPath2.resolve(t)),this._closePath(t),this._addIgnoredPath(t),this._watched.has(t)&&this._addIgnoredPath({path:t,recursive:!0}),this._userIgnored=void 0})}return this}close(){if(!this._closePromise){this.closed=!0,this.removeAllListeners();const s=[];this._closers.forEach(t=>t.forEach(t=>{var e=t();e instanceof Promise&&s.push(e)})),this._streams.forEach(t=>t.destroy()),this._userIgnored=void 0,this._readyCount=0,this._readyEmitted=!1,this._watched.forEach(t=>t.dispose()),this._closers.clear(),this._watched.clear(),this._streams.clear(),this._symlinkPaths.clear(),this._throttled.clear(),this._closePromise=s.length?Promise.all(s).then(()=>{}):Promise.resolve()}return this._closePromise}getWatched(){const i={};return this._watched.forEach((t,e)=>{var s=(this.options.cwd?sysPath2.relative(this.options.cwd,e):e)||ONE_DOT;i[s]=t.getChildren().sort()}),i}emitWithAll(t,e){this.emit(t,...e),t!==EVENTS.ERROR&&this.emit(EVENTS.ALL,t,...e)}async _emit(s,e,i){if(!this.closed){var r=this.options;isWindows&&(e=sysPath2.normalize(e));const h=[e=r.cwd?sysPath2.relative(r.cwd,e):e];null!=i&&h.push(i);var a=r.awaitWriteFinish;let t;if(a&&(t=this._pendingWrites.get(e)))t.lastChange=new Date;else{if(r.atomic){if(s===EVENTS.UNLINK)return this._pendingUnlinks.set(e,[s,...h]),setTimeout(()=>{this._pendingUnlinks.forEach((t,e)=>{this.emit(...t),this.emit(EVENTS.ALL,...t),this._pendingUnlinks[\\\"delete\\\"](e)})},\\\"number\\\"==typeof r.atomic?r.atomic:100),this;s===EVENTS.ADD&&this._pendingUnlinks.has(e)&&(s=EVENTS.CHANGE,this._pendingUnlinks[\\\"delete\\\"](e))}if(a&&(s===EVENTS.ADD||s===EVENTS.CHANGE)&&this._readyEmitted)this._awaitWriteFinish(e,a.stabilityThreshold,s,(t,e)=>{t?(s=EVENTS.ERROR,h[0]=t,this.emitWithAll(s,h)):e&&(1<h.length?h[1]=e:h.push(e),this.emitWithAll(s,h))});else{if(s===EVENTS.CHANGE)if(!this._throttle(EVENTS.CHANGE,e,50))return this;if(r.alwaysStat&&void 0===i&&(s===EVENTS.ADD||s===EVENTS.ADD_DIR||s===EVENTS.CHANGE)){a=r.cwd?sysPath2.join(r.cwd,e):e;let t;try{t=await(0,import_promises3.stat)(a)}catch(o){}if(!t||this.closed)return;h.push(t)}this.emitWithAll(s,h)}}return this}}_handleError(t){var e=t&&t.code;return t&&\\\"ENOENT\\\"!==e&&\\\"ENOTDIR\\\"!==e&&(!this.options.ignorePermissionErrors||\\\"EPERM\\\"!==e&&\\\"EACCES\\\"!==e)&&this.emit(EVENTS.ERROR,t),t||this.closed}_throttle(t,s,e){this._throttled.has(t)||this._throttled.set(t,new Map);const i=this._throttled.get(t);if(!i)throw new Error(\\\"invalid throttle\\\");var r=i.get(s);if(r)return r.count++,!1;let a;r=()=>{var t=i.get(s),e=t?t.count:0;return i[\\\"delete\\\"](s),clearTimeout(a),t&&clearTimeout(t.timeoutObject),e},r={timeoutObject:a=setTimeout(r,e),clear:r,count:0};return i.set(s,r),r}_incrReadyCount(){return this._readyCount++}_awaitWriteFinish(a,o,e,h){var s=this.options.awaitWriteFinish;if(\\\"object\\\"==typeof s){const l=s.pollInterval;let r,t=a;this.options.cwd&&!sysPath2.isAbsolute(a)&&(t=sysPath2.join(this.options.cwd,a));s=new Date;const d=this._pendingWrites;d.has(a)||(d.set(a,{lastChange:s,cancelWait:()=>(d[\\\"delete\\\"](a),clearTimeout(r),e)}),r=setTimeout(function n(i){(0,import_fs2.stat)(t,(t,e)=>{var s;t||!d.has(a)?t&&\\\"ENOENT\\\"!==t.code&&h(t):(s=Number(new Date),i&&e.size!==i.size&&(d.get(a).lastChange=s),s-=d.get(a).lastChange,o<=s?(d[\\\"delete\\\"](a),h(void 0,e)):r=setTimeout(n,l,e))})},l))}}_isIgnored(t,e){var s,i;return!(!this.options.atomic||!DOT_RE.test(t))||(this._userIgnored||(i=this.options.cwd,s=(this.options.ignored||[]).map(normalizeIgnored(i)),i=[...[...this._ignoredPaths].map(normalizeIgnored(i)),...s],this._userIgnored=anymatch(i,void 0)),this._userIgnored(t,e))}_isntIgnored(t,e){return!this._isIgnored(t,e)}_getWatchHelpers(t){return new WatchHelper(t,this.options.followSymlinks,this)}_getWatchedDir(t){var e=sysPath2.resolve(t);return this._watched.has(e)||this._watched.set(e,new DirEntry(e,this._boundRemove)),this._watched.get(e)}_hasReadPermissions(t){return!!this.options.ignorePermissionErrors||Boolean(256&Number(t.mode))}_remove(e,s,i){const r=sysPath2.join(e,s);var a=sysPath2.resolve(r);if(i=null!=i?i:this._watched.has(r)||this._watched.has(a),this._throttle(\\\"remove\\\",r,100)){i||1!==this._watched.size||this.add(e,s,!0);this._getWatchedDir(r).getChildren().forEach(t=>this._remove(r,t));var o=this._getWatchedDir(e),h=o.has(s);o.remove(s),this._symlinkPaths.has(a)&&this._symlinkPaths[\\\"delete\\\"](a);let t=r;if(this.options.cwd&&(t=sysPath2.relative(this.options.cwd,r)),this.options.awaitWriteFinish&&this._pendingWrites.has(t))if(this._pendingWrites.get(t).cancelWait()===EVENTS.ADD)return;this._watched[\\\"delete\\\"](r),this._watched[\\\"delete\\\"](a);o=i?EVENTS.UNLINK_DIR:EVENTS.UNLINK;h&&!this._isIgnored(r)&&this._emit(o,r),this._closePath(r)}}_closePath(t){this._closeFile(t);var e=sysPath2.dirname(t);this._getWatchedDir(e).remove(sysPath2.basename(t))}_closeFile(t){var e=this._closers.get(t);e&&(e.forEach(t=>t()),this._closers[\\\"delete\\\"](t))}_addPathCloser(e,s){if(s){let t=this._closers.get(e);t||(t=[],this._closers.set(e,t)),t.push(s)}}_readdirp(e,s){if(!this.closed){var i=__spreadProps(__spreadValues({type:EVENTS.ALL,alwaysStat:!0,lstat:!0},s),{depth:0});let t=readdirp(e,i);return this._streams.add(t),t.once(STR_CLOSE,()=>{t=void 0}),t.once(STR_END,()=>{t&&(this._streams[\\\"delete\\\"](t),t=void 0)}),t}}};function watch(t,e={}){var s=new FSWatcher(e);return s.add(t),s}var esm_default={watch:watch,FSWatcher:FSWatcher},chokidar_default=esm_default;\"},\"$:/plugins/linonetwo/watch-fs/startup-moniter.js\":{\"title\":\"$:/plugins/linonetwo/watch-fs/startup-moniter.js\",\"type\":\"application/javascript\",\"module-type\":\"startup\",\"Modern.TiddlyDev#Origin\":\"startup-moniter.ts\",\"text\":\"\\\"use strict\\\";exports.name=\\\"watch-fs_FileSystemMonitor\\\",exports.after=[\\\"load-modules\\\"],exports.platforms=[\\\"node\\\"],exports.synchronous=!0,exports.startup=()=>{var t;\\\"undefined\\\"!=typeof $tw&&null!=$tw&&$tw.node&&$tw.syncadaptor&&\\\"true\\\"!==process.env.TEST&&(t=require(\\\"$:/plugins/linonetwo/watch-fs/FileSystemMonitor.js\\\").FileSystemMonitor,t=new t,$tw.watchFs=t)};\"}}}","title":"$:/plugins/linonetwo/watch-fs","type":"application/json","version":"0.2.0","Modern.TiddlyDev#SHA256-Hashed":"301fd8cde18fb849b5ab57e307b1cca269d8ff6b20341ee4b9ebaa914afe949c","name":"Watch FileSystem Auto Reload Wiki"}