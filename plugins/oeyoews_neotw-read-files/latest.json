{"title":"$:/plugins/oeyoews/neotw-read-files","description":"扩展TiddlyWiki读取目录","author":"oeyoews","version":"0.0.1","core-version":">=5.3.0","type":"application/json","plugin-type":"plugin","name":"Neotw Read Files","dependents":"","list":"readme","text":"{\"tiddlers\":{\"$:/plugins/oeyoews/neotw-read-files/readme\":{\"title\":\"$:/plugins/oeyoews/neotw-read-files/readme\",\"text\":\"* 导入的图片不会被删除, 需要手动在files 文件夹里面手动删除\\n* 此插件是关于 tiddlywiki 的路由实验性插件，其中的  ImportToExternalFile  是在 saqimtiaz 的插件基础上修改而来的 (仅仅适用于 tiddlywiki-starter-kit 的用例场景)\\n\\n* https://groups.google.com/g/tiddlywiki/c/T0MP1Adzzk0\\n* https://saqimtiaz.github.io/sq-tw/temp/import-to-external-file.html\"},\"$:/config/sq/OverwriteBinaryFiles\":{\"title\":\"$:/config/sq/OverwriteBinaryFiles\",\"text\":\"yes\"},\"$:/config/sq/SaveAsExternalFile\":{\"title\":\"$:/config/sq/SaveAsExternalFile\",\"text\":\"yes\"},\"$:/plugins/oeyoews/neotw-read-files/routes/get-file.js\":{\"title\":\"$:/plugins/oeyoews/neotw-read-files/routes/get-file.js\",\"text\":\"/*\\\\\\ntitle: $:/plugins/oeyoews/neotw-read-files/routes/get-file.js\\ntype: application/javascript\\nmodule-type: route\\n\\nneotw-read-files GET /images/:filepath\\n由 https://github.com/Jermolene/TiddlyWiki5/blob/ceee20fd5970e1b75c2117d2522c998a6c5054f3/core/modules/server/routes/get-file.js 改写\\n\\nhttps://github.com/Jermolene/TiddlyWiki5/discussions/7964\\n\\n\\\\*/\\n!function(){\\\"use strict\\\";exports.method=\\\"GET\\\";const e=$tw.wiki.getTiddlerText(\\\"$:/plugins/oeyoews/neotw-read-files/custom-path\\\")||\\\"static\\\";exports.path=new RegExp(`^/${e}/(.+)`),exports.handler=function(t,n,o){var i=require(\\\"path\\\"),s=require(\\\"fs\\\"),r=$tw.utils.decodeURIComponentSafe(o.params[0]),a=i.resolve(o.boot.wikiPath,e),l=i.resolve(a,r),p=i.extname(l);0!==i.relative(a,l).indexOf(\\\"..\\\")?s.readFile(l,(function(e,t){var n,i=\\\"text/plain\\\";e?(console.log(\\\"Error accessing file \\\"+l+\\\": \\\"+e.toString()),n=404,t=\\\"File '\\\"+r+\\\"' not found\\\"):(n=200,i=$tw.config.fileExtensionInfo[p]?$tw.config.fileExtensionInfo[p].type:\\\"application/octet-stream\\\"),o.sendResponse(n,{\\\"Content-Type\\\":i},t)})):o.sendResponse(404,{\\\"Content-Type\\\":\\\"text/plain\\\"},\\\"File '\\\"+r+\\\"' not found\\\")}}();\",\"type\":\"application/javascript\",\"module-type\":\"route\"},\"$:/plugins/sq/ImportToExternalFile/server-route-upload.js\":{\"title\":\"$:/plugins/sq/ImportToExternalFile/server-route-upload.js\",\"text\":\"/*\\\\\\ntitle: $:/plugins/sq/ImportToExternalFile/server-route-upload.js\\ntype: application/javascript\\nmodule-type: route\\n\\nPOST /^\\\\/api\\\\/upload/\\n\\nUpload media\\n\\n\\\\*/\\n!function(){\\\"use strict\\\";exports.method=\\\"POST\\\",exports.path=new RegExp(\\\"^/api/upload\\\"),exports.bodyFormat=\\\"stream\\\";const e=require(\\\"fs\\\"),t=require(\\\"path\\\");exports.handler=function(i,n,l){let o=\\\"\\\";i.on(\\\"data\\\",(function(e){o+=e,o.length>1e7&&(n.writeHead(413,{\\\"Content-Type\\\":\\\"text/plain\\\"}).end(),i.connection.destroy())})),i.on(\\\"end\\\",(function(){try{let l=JSON.parse(o);const s=t.resolve($tw.boot.wikiTiddlersPath,\\\"./files\\\");\\n/*\\n            var xfilepath = $tw.utils.generateTiddlerFilepath(bodyData.tiddler.fields.title,{\\n                directory: filesPath\\n            });\\n            //var ext = path.extname(originalpath);\\n            //xfilepath = xfilepath.substring(0,xfilepath.length - ext.length);\\n\\n\\n            // 1) try to increment filename before extension.\\n            // 2) don't encode / in file path so can specify a subdir\\n            xfilepath = path.join(filesPath, bodyData.tiddler.fields.title); //with this tiddler titles like images/filename work but only if directory exists\\n            console.log(xfilepath);\\n\\t\\t\\t*/var i=r(l.tiddler.fields.title);$tw.utils.createDirectory(s);const a=Buffer.from(l.tiddler.fields.text,\\\"base64\\\"),c=i;\\n//const filename = path.join(filesPath, bodyData.tiddler.fields.title);\\ne.writeFile(t.join(i),a,(function(e){if(e)throw console.log(e),e;console.log(\\\"文件已保存\\\"+c),n.setHeader(\\\"Content-Type\\\",\\\"application/json\\\"),n.end(JSON.stringify({success:\\\"saved \\\"+l.tiddler.fields.title,status:200,\\n//\\\"_canonical_uri\\\":\\t \\\"files/\\\" + bodyData.tiddler.fields.title,\\n_canonical_uri:t.relative(t.resolve($tw.boot.wikiTiddlersPath,\\\"..\\\"),i),tiddler:l.tiddler.fields.title}))}))}catch(e){console.log(\\\"Error parsing or writing uploaded file\\\",e,{level:2}),n.writeHead(400),n.end()}}))};var r=function(r,i){const n=t.resolve($tw.boot.wikiTiddlersPath,\\\"../../files/\\\");var l=r.replace(/\\\\/|\\\\\\\\/g,\\\"_\\\");l=(l=l.replace(/^(con|prn|aux|nul|com[0-9]|lpt[0-9])$/i,\\\"_$1_\\\")).replace(/^ +/,(function(e){return e.replace(/ /g,\\\"_\\\")})),/^\\\\.{1,2}[/\\\\\\\\]/g.test(l)||(l=l.replace(/^\\\\.+/g,(function(e){return e.replace(/\\\\./g,\\\"_\\\")}))),l=l.replace(/[\\\\x00-\\\\x1f\\\\x80-\\\\x9f]/g,\\\"_\\\"),l=$tw.utils.transliterate(l.replace(/<|>|~|\\\\:|\\\\\\\"|\\\\||\\\\?|\\\\*|\\\\^/g,\\\"_\\\"));var o=t.extname(r);if(l=l.substring(0,l.length-o.length),(o=o.replace(/[\\\\. ]+$/,(function(e){return e.replace(/[\\\\. ]/g,\\\"_\\\")}))).length>32&&(o=o.substr(0,32)),l.length>200&&(l=l.substr(0,200)),\\n// If the resulting filename is blank (eg because the title is just punctuation)\\nl&&!/^_+$/g.test(l)||(\\n// ...then just use the character codes of the title\\nl=\\\"\\\",$tw.utils.each(r.split(\\\"\\\"),(function(e){l&&(l+=\\\"-\\\"),l+=e.charCodeAt(0).toString()}))),\\\"yes\\\"===$tw.wiki.getTextReference(\\\"!!text\\\",\\\"yes\\\",\\\"$:/config/sq/OverwriteBinaryFiles\\\"))return t.resolve(n,l+o);var s,a=0;do{s=t.resolve(n,l+(a?\\\"_\\\"+a:\\\"\\\")+o),a++}while(e.existsSync(s));return s}}();\",\"type\":\"application/javascript\",\"module-type\":\"route\"},\"$:/plugins/sq/ImportToExternalFile/startup.js\":{\"title\":\"$:/plugins/sq/ImportToExternalFile/startup.js\",\"text\":\"/*\\\\\\ntitle: $:/plugins/sq/ImportToExternalFile/startup.js\\ntype: application/javascript\\nmodule-type: startup\\n\\nThis adds a hook for the \\\"th-importing-tiddler\\\"\\n\\n\\\\*/\\n!function(){\\\"use strict\\\";exports.name=\\\"sq-server-images\\\",exports.platforms=[\\\"browser\\\"],exports.after=[\\\"render\\\"],exports.synchronous=!0,exports.startup=function(){function e(e){}function t(e){}function i(e){console.log(\\\"Failed!\\\")}function n(e){console.log(\\\"Cancelled!\\\")}$tw.hooks.addHook(\\\"th-importing-tiddler\\\",(function(a){if(\\\"yes\\\"!==$tw.wiki.getTextReference(\\\"!!text\\\",\\\"yes\\\",\\\"$:/config/sq/SaveAsExternalFile\\\"))return a;if([\\\"image/gif\\\",\\\"image/x-icon\\\",\\\"image/jpeg\\\",\\\"image/jpeg\\\",\\\"image/png\\\",\\\"image/svg+xml\\\",\\\"application/pdf\\\",\\\"application/zip\\\",\\\"application/font-woff\\\",\\\"application/x-font-ttf\\\",\\\"audio/ogg\\\",\\\"video/mp4\\\",\\\"audio/mp3\\\",\\\"audio/mp4\\\"].indexOf(a.fields.type)>-1&&!a.fields._canonical_uri){let d=new XMLHttpRequest;d.upload.addEventListener(\\\"progress\\\",e),d.upload.addEventListener(\\\"load\\\",t),d.upload.addEventListener(\\\"error\\\",i),d.upload.addEventListener(\\\"abort\\\",n),d.onreadystatechange=function(){if(4==this.readyState&&200==this.status){console.info(this.response);var e=null;try{e=JSON.parse(this.response)}catch(e){}if(e){let t=$tw.wiki.getTiddler(e.tiddler),i=e._canonical_uri;e._canonical_uri.startsWith(\\\"..\\\")&&(i=i.replace(\\\"..\\\",\\\".\\\")),$tw.wiki.addTiddler(new $tw.Tiddler(t,{_canonical_uri:i,text:\\\"\\\"}))}}};let l=\\\"/api/upload\\\";d.open(\\\"POST\\\",l,!0);var o={tiddler:a};d.setRequestHeader(\\\"X-Requested-With\\\",\\\"TiddlyWiki\\\"),d.send(JSON.stringify(o));var r={},s=\\\"/files/\\\"+a.fields.title;\\n//Use tw.utils.generateTiddlerFilePath //remove / etc from title\\nreturn r.title=a.fields.title,r.type=a.fields.type,r._canonical_uri=s,a}return a}))}}();\",\"type\":\"application/javascript\",\"module-type\":\"startup\"},\"$:/core/ui/ViewTemplate/import-external-files\":{\"title\":\"$:/core/ui/ViewTemplate/import-external-files\",\"tags\":\"$:/tags/ViewTemplate\",\"list-after\":\"$:/core/ui/ViewTemplate/import\",\"text\":\"<$list filter=\\\"[all[current]field:plugin-type[import]]\\\" variable=\\\"null\\\">\\n\\n<$checkbox tiddler=\\\"$:/config/sq/SaveAsExternalFile\\\" field=\\\"text\\\" checked=\\\"yes\\\" unchecked=\\\"no\\\" default=\\\"yes\\\"> Import binary files as external attachments</$checkbox>\\n\\n<$list filter=\\\"[{$:/config/sq/SaveAsExternalFile}match[yes]]\\\" variable=\\\"null\\\">\\n<$checkbox tiddler=\\\"$:/config/sq/OverwriteBinaryFiles\\\" field=\\\"text\\\" checked=\\\"yes\\\" unchecked=\\\"no\\\" default=\\\"yes\\\"> Overwrite binary files with the same name</$checkbox>\\n</$list>\\n\\n</$list>\"}}}"}